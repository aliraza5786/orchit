import{D as Z,N as xe,m as g,E as M,d as Je,r as v,l as D,p as ce,O as Xe,ar as ue,c as b,bd as Ye,I as Ze,a as et,w as y,y as j,z as tt,b as s,g as h,T as F,h as l,L as me,f as pe,a4 as X,t as c,i as S,F as E,x as st,v as $,B as Y,e as K,P as ve,o as i,_ as at}from"./index-5j6IPDxv.js";import{B as ot}from"./BaseRichTextEditor-ev4Fsqww.js";import{h as it,u as lt}from"./KanbanSkeleton-DPgJkG6M.js";import{_ as he}from"./BaseSelectField.vue_vue_type_script_setup_true_lang-DeZcn4sC.js";import{D as fe}from"./DatePicker-CZnu33NT.js";import{_ as nt}from"./AssigmentDropdown.vue_vue_type_script_setup_true_lang-BdonnKni.js";import{u as dt}from"./useQueryParams-BeRzVyTs.js";import{b as rt}from"./useCommon-33XOSRJp.js";import{S as ct}from"./SwitchTab-B71IshUI.js";import"./BaseTextField.vue_vue_type_script_setup_true_lang-DHFf7hlT.js";import"./info-DjaLHeD_.js";import"./index-BhxjB58g.js";const ut=(d,p={})=>xe({queryKey:["comments",d],queryFn:({signal:I})=>M({url:`workspace/cards/${g(d)}/comments`,method:"GET",signal:I}),...p,enabled:!!g(d)}),mt=(d={})=>Z({key:["add-comment"]},{mutationFn:p=>M({url:`workspace/cards/${p.id}/comments`,method:"POST",data:p.payload}),...d}),pt=(d={})=>Z({key:["delete-comment"]},{mutationFn:p=>M({url:`/workspace/comments/${p.id}`,method:"DELETE",data:p.payload}),...d}),vt=(d={})=>Z({key:["update-comment"]},{mutationFn:p=>M({url:`workspace/comments/${p.id}`,method:"PUT",data:p.payload}),...d}),ht=(d,p={})=>xe({queryKey:["product-card",d],queryFn:({signal:I})=>M({url:`/workspace/card/${g(d)}`,method:"GET",signal:I}),...p,enabled:!!g(d)}),ft={class:"flex flex-col max-w-[380px] min-w-[380px] h-full overflow-y-auto bg-gradient-to-b from-bg-card/95 to-bg-card/90 backdrop-blur rounded-2xl shadow-[0_10px_40px_-10px_rgba(0,0,0,.5)] border border-orchit-white/5 overflow-hidden",role:"complementary","aria-label":"Details panel"},xt={class:"sticky top-0 z-10 bg-transparent border-b border-orchit-white/5 px-6 py-4 flex items-center justify-between"},gt={class:"py-5 px-6 flex flex-col gap-5 flex-grow"},_t={class:"capitalize"},bt=["onKeydown"],yt=["innerHTML"],wt={key:1,class:"opacity-60"},kt={key:"tab-details",class:"space-y-6"},Ct={class:"grid grid-cols-2 gap-4 text-sm"},Dt={class:"rounded-xl bg-orchit-white/5 border border-orchit-white/10 p-4"},St={class:"mt-1 font-medium"},Et={class:"rounded-xl bg-orchit-white/5 border border-orchit-white/10 p-4"},Tt={class:"mt-1 font-medium"},Vt={class:"rounded-2xl border border-orchit-white/10 bg-orchit-white/5 p-4 grid grid-cols-1 sm:grid-cols-2 gap-4"},Ut={class:"space-y-2"},It={class:"space-y-2"},Pt={class:"space-y-2"},Lt={class:"h-8 px-3 flex items-center gap-2 rounded-lg bg-bg-input border border-orchit-white/10"},Bt={class:"space-y-2"},Ft={key:0,class:"text-xs text-red-400 mt-1"},$t={key:0,class:"space-y-2 sm:col-span-1"},Mt={class:"text-xs uppercase tracking-wider text-text-secondary"},qt={key:1},zt={class:"relative border-l border-orchit-white/10 pl-5 space-y-4 ml-1"},Ot={class:"rounded-xl bg-orchit-white/5 border border-orchit-white/10 p-3 hover:bg-orchit-white/7 transition"},At={class:"font-semibold"},jt={class:"font-semibold"},Kt={key:"tab-comments",class:"space-y-4"},Nt={class:"flex items-center gap-3 mb-2"},Ht={class:"h-8 w-8 rounded-full bg-accent/15 text-accent flex items-center justify-center text-xs font-semibold"},Qt={class:"flex-1"},Rt={class:"text-sm font-medium"},Wt={class:"text-xs text-text-secondary"},Gt={key:0,class:"flex items-center gap-2"},Jt=["onClick"],Xt=["onClick"],Yt={class:"flex items-center gap-2 justify-end"},Zt={key:0,class:"mt-3 grid grid-cols-2 gap-2"},es=["href"],ts={class:"text-xs truncate"},ss={class:"rounded-xl border border-orchit-white/10 bg-orchit-white/5 overflow-hidden"},as={class:"flex items-center justify-between p-2 border-t border-orchit-white/10"},os={key:"tab-attachments",class:"space-y-3"},is={class:"text-xs text-text-secondary"},ls={class:"grid sm:grid-cols-2 gap-4"},ns={class:"p-3"},ds={key:0,class:"rounded-lg overflow-hidden"},rs=["src"],cs={key:1,class:"rounded-lg overflow-hidden"},us=["src"],ms={key:2,class:"h-40 rounded-lg bg-black/5 grid place-items-center"},ps={class:"mt-3"},vs={class:"font-medium truncate"},hs={class:"text-xs text-text-secondary capitalize"},fs={class:"p-3 pt-0"},xs=["href"],gs=Je({__name:"SidePanel",props:{pin:{type:Boolean,default:!1},showPanel:{type:Boolean,default:!0},details:{type:Object,default:()=>({})}},emits:["close","update:details","comment:post","priority:change"],setup(d,{emit:p}){var ne,de;const{workspaceId:I}=dt(),n=d,ge=p,{data:_}=ht(n.details._id),P=v("details"),_e=[{label:"Details",value:"details"},{label:"Comments",value:"comments"},{label:"History",value:"history"},{label:"Attachment",value:"attachment"}],q=v(!1),w=v(n.details["card-title"]??"");D(()=>n.details["card-title"],t=>{w.value=t});const N=v(null);function be(){q.value=!0,ve(()=>{var t,e;(t=N.value)==null||t.focus(),(e=N.value)==null||e.select()})}function ee(){w.value.trim()||(w.value=n.details["card-title"]??""),k.mutate({card_id:n.details._id,variables:{"card-title":w.value.trim()}}),q.value=!1}const T=v(n.details["card-description"]);D(()=>n.details,()=>{T.value=n.details["card-description"]});const z=v(!1),H=v(null);function ye(t){var m,a;const e=(m=t==null?void 0:t.querySelector)==null?void 0:m.call(t,".ProseMirror");if(!e)return;e.focus();const o=(a=window.getSelection)==null?void 0:a.call(window),r=document.createRange();r.selectNodeContents(e),r.collapse(!1),o==null||o.removeAllRanges(),o==null||o.addRange(r)}async function we(){z.value=!0,await ve(),ye(H.value||void 0)}function te(t){k.mutate({card_id:n.details._id,attachments:t??[],variables:{"card-description":T.value}}),z.value=!1}function se(t){var o;if(!z.value)return;const e=t.target;(o=H.value)!=null&&o.contains(e)||te()}ce(()=>document.addEventListener("mousedown",se)),Xe(()=>document.removeEventListener("mousedown",se));const ae=ue({posted_on:((ne=n.details)==null?void 0:ne.posted_on)??((de=n.details)==null?void 0:de.created_at)??new Date().toISOString()}),ke=b({get:()=>new Date(ae.posted_on).toISOString().slice(0,10),set:t=>{ae.posted_on=new Date(t+"T00:00:00").toISOString()}}),{data:Q}=it(I.value),R=v(n.details.workspace_lane_id??"");D(()=>n.details.workspace_lane_id,t=>{R.value=t});const Ce=b(()=>((Q==null?void 0:Q.value)??[]).map(t=>{var e;return{_id:t._id,title:((e=t==null?void 0:t.variables)==null?void 0:e["lane-title"])??String(t._id)}}));function De(t){R.value=t,k.mutate({card_id:n.details._id,workspace_lane_id:t})}const f=v({startDate:n.details["start-date"],endDate:n.details["end-date"]}),Se=b(()=>n.details["start-date"]),Ee=b(()=>n.details["end-date"]);D(Se,t=>{f.value={...f.value,startDate:t}}),D(Ee,t=>{f.value={...f.value,endDate:t}});const W=b(()=>f!=null&&f.value.startDate&&f.value.endDate&&f.value.endDate<f.value.startDate?"End date cannot be before start date":""),Te=t=>k.mutate({card_id:n.details._id,variables:{"start-date":t}}),Ve=t=>k.mutate({card_id:n.details._id,variables:{"end-date":t}}),Ue=b(()=>n.details.assigned_to),Ie=t=>{var e;k.mutate({card_id:n.details._id,assigned_to:(e=t==null?void 0:t.user_info)==null?void 0:e._id})},u=v([]),Pe=b(()=>{var t;return(t=n.details)==null?void 0:t._id}),{data:oe}=ut(Pe);D(()=>oe.value,()=>{var t;u.value=(t=oe.value)==null?void 0:t.comments});const{mutate:Le,isPending:Be}=mt({onSuccess:t=>{L.value="",B.value=[],u.value=[...u.value,t]}}),L=v(""),Fe=t=>(t??"").split(" ").map(e=>e[0]).filter(Boolean).slice(0,2).join("").toUpperCase(),$e=t=>t?new Date(t).toLocaleString():"",{data:Me}=Ye(),qe=t=>{var e;return((e=t==null?void 0:t.created_by)==null?void 0:e._id)===Me.value},O=v(null),V=v(""),{mutate:ze,isPending:ie}=vt(),{mutate:Oe}=pt();function Ae(t){O.value=t._id,V.value=t.comment_text??""}function G(){O.value=null,V.value="",q.value=!1}function je(t){const e=V.value.trim();if(!e)return;const o=u.value.findIndex(m=>m._id===t._id),r=o>-1?{...u.value[o]}:null;o>-1&&(u.value[o]={...u.value[o],comment_text:e}),ze({id:t._id,payload:{comment_text:e}},{onError:()=>{o>-1&&r&&(u.value[o]=r)},onSuccess:m=>{o>-1&&(u.value[o]=m??u.value[o]),G()}})}function Ke(t){const e=u.value.findIndex(r=>r._id===t._id),o=e>-1?u.value[e]:null;e>-1&&u.value.splice(e,1),Oe({id:t._id},{onError:()=>{o&&u.value.splice(e,0,o)}})}const Ne=b(()=>{var t;return(((t=n.details)==null?void 0:t.attachments)??[]).map(e=>{var o;return{_id:e._id??e.id??((o=crypto.randomUUID)==null?void 0:o.call(crypto))??Math.random(),name:e.name??e.filename??"file",url:e.url,kind:(e.type??e.kind??"").toLowerCase().includes("image")?"image":(e.type??e.kind??"").toLowerCase().includes("video")?"video":"file"}})}),J=Ze(),k=lt({onSuccess:()=>{J.invalidateQueries({queryKey:["get-sheets"]}),J.invalidateQueries({queryKey:["sheet-list"]}),J.invalidateQueries({queryKey:["roles"]})}}),B=v([]),{mutate:He}=rt({onSuccess:t=>{B.value=[t]}});function Qe(t){const e=t.target.files;Array.from(e).forEach(o=>{const r=new FormData;r.append("file",o),He(r)})}function Re(){const t=L.value.trim();!t&&!B.value.length||Le({id:n.details._id,payload:{comment_text:t,attachments:B.value.map(e=>({name:e.data.name,url:e.data.url}))}})}const A=ue({}),le=()=>{var t;(t=_==null?void 0:_.value)!=null&&t.variables&&(_.value.variables??[]).forEach(o=>{var m,a;if(!o||o.type!=="Select")return;const r=Array.isArray(o.data)&&o.data.length?((m=o.data[0])==null?void 0:m.value)??((a=o.data[0])==null?void 0:a._id)??o.data[0]:void 0;A[o.slug]=o.value??A[o.slug]??r??null})};ce(le),D(()=>_.value,le,{deep:!0});function We(t,e){var r,m;A[e]=t,((m=(((r=_.value)==null?void 0:r.variables)??[]).find(a=>a.slug===e))==null?void 0:m.value)!==t&&k.mutate({card_id:n.details._id,variables:{[e]:t}})}return(t,e)=>(i(),et(F,{name:"panel",appear:""},{default:y(()=>[j(s("div",ft,[s("div",xt,[e[7]||(e[7]=s("h5",{class:"text-[18px] font-semibold tracking-tight"},"Details",-1)),s("button",{class:"p-2 rounded-xl hover:bg-orchit-white/5 active:scale-[.98] cursor-pointer transition",onClick:e[0]||(e[0]=()=>ge("close")),"aria-label":"Close details"},e[6]||(e[6]=[s("i",{class:"fa-solid fa-xmark text-xl"},null,-1)]))]),s("div",gt,[s("div",_t,[h(F,{name:"fade-scale",mode:"out-in"},{default:y(()=>[q.value?j((i(),l("input",{key:"title-edit",ref_key:"titleInput",ref:N,"onUpdate:modelValue":e[1]||(e[1]=o=>w.value=o),onBlur:ee,onKeydown:[me(pe(ee,["prevent"]),["enter"]),me(pe(G,["prevent"]),["esc"])],class:"w-full text-2xl font-semibold rounded-xl px-3 py-2 bg-orchit-white/5 border border-orchit-white/10 focus:outline-none focus:ring-2 focus:ring-accent/40 transition",type:"text","aria-label":"Edit title"},null,40,bt)),[[X,w.value]]):(i(),l("h1",{key:"title-view",class:"text-2xl font-semibold tracking-tight cursor-text rounded-lg px-2 py-1 hover:bg-orchit-white/5 transition",onClick:be,"aria-label":"Card title"},c(w.value||"Untitled"),1))]),_:1})]),s("div",null,[e[8]||(e[8]=s("h3",{class:"mb-2 text-base font-semibold tracking-wide px-1"},"Description",-1)),h(F,{name:"fade-scale",mode:"out-in"},{default:y(()=>[z.value?(i(),l("div",{key:"desc-edit",ref_key:"descEditorWrap",ref:H,class:"rounded-xl overflow-hidden border border-orchit-white/10 shadow-sm"},[h(ot,{modelValue:T.value,"onUpdate:modelValue":e[2]||(e[2]=o=>T.value=o),onFocusOut:te},null,8,["modelValue"])],512)):(i(),l("div",{key:"desc-view",class:"text-[15px] leading-6 text-text-secondary whitespace-pre-wrap cursor-text rounded-xl px-4 py-3 border border-orchit-white/10 bg-orchit-white/5 hover:border-orchit-white/20 transition",onClick:we},[T.value?(i(),l("div",{key:0,innerHTML:T.value},null,8,yt)):(i(),l("span",wt,"Click to add a description…"))]))]),_:1})]),h(ct,{modelValue:P.value,"onUpdate:modelValue":e[3]||(e[3]=o=>P.value=o),options:_e,size:"md"},null,8,["modelValue"]),h(F,{name:"section",mode:"out-in"},{default:y(()=>{var o,r,m;return[P.value==="details"?(i(),l("section",kt,[s("div",Ct,[s("div",Dt,[e[9]||(e[9]=s("div",{class:"text-xs uppercase tracking-wider text-text-secondary"},"Posted On",-1)),s("div",St,c(ke.value),1)]),s("div",Et,[e[10]||(e[10]=s("div",{class:"text-xs uppercase tracking-wider text-text-secondary"},"ID",-1)),s("div",Tt,c(d.details["card-code"]),1)])]),s("div",Vt,[s("div",Ut,[e[11]||(e[11]=s("div",{class:"text-xs uppercase tracking-wider text-text-secondary"},"Lane",-1)),h(he,{size:"sm",options:Ce.value,placeholder:"Select lane",allowCustom:!1,"model-value":R.value,"onUpdate:modelValue":De},null,8,["options","model-value"])]),s("div",It,[e[12]||(e[12]=s("div",{class:"text-xs uppercase tracking-wider text-text-secondary"},"Assign",-1)),h(nt,{onAssign:Ie,assigneeId:Ue.value,seat:d.details.seat},null,8,["assigneeId","seat"])]),d.pin?S("",!0):(i(),l(E,{key:0},[s("div",Pt,[e[14]||(e[14]=s("div",{class:"text-xs uppercase tracking-wider text-text-secondary"},"Start Date",-1)),s("div",Lt,[e[13]||(e[13]=s("i",{class:"fa-regular fa-calendar"},null,-1)),h(fe,{placeholder:"Set start date",class:"w-full","model-value":f.value.startDate,"emit-as":"ymd","onUpdate:modelValue":Te},null,8,["model-value"])])]),s("div",Bt,[e[16]||(e[16]=s("div",{class:"text-xs uppercase tracking-wider text-text-secondary"},"Target End",-1)),s("div",{class:st(["h-8 px-3 flex items-center gap-2 rounded-lg bg-bg-input border transition-colors",W.value?"border-red-500":"border-orchit-white/10"])},[e[15]||(e[15]=s("i",{class:"fa-regular fa-calendar"},null,-1)),h(fe,{placeholder:"Set end date",class:"w-full","model-value":f.value.endDate,"emit-as":"ymd","onUpdate:modelValue":Ve},null,8,["model-value"])],2),W.value?(i(),l("p",Ft,c(W.value),1)):S("",!0)])],64)),(o=g(_))!=null&&o.variables?(i(!0),l(E,{key:1},$((r=g(_))==null?void 0:r.variables,(a,U)=>(i(),l(E,{key:a.slug||`var-${U}`},[(a==null?void 0:a.type)==="Select"?(i(),l("div",$t,[s("div",Mt,c(a.title),1),h(he,{size:"sm",options:a==null?void 0:a.data.map(C=>({_id:C,title:C})),placeholder:"Select option",allowCustom:!1,"model-value":A[a.slug],"onUpdate:modelValue":C=>We(C,a.slug)},null,8,["options","model-value","onUpdate:modelValue"])])):S("",!0)],64))),128)):S("",!0)])])):P.value==="history"?(i(),l("section",qt,[s("div",null,[e[19]||(e[19]=s("h3",{class:"text-sm font-semibold tracking-wide mb-3"},"History",-1)),s("ol",zt,[(i(!0),l(E,null,$(d.details.history,(a,U)=>(i(),l("li",{key:U,class:"group"},[e[18]||(e[18]=s("span",{class:"absolute -left-[5px] top-0 w-2 h-2 rounded-full bg-accent/70 ring-4 ring-accent/10"},null,-1)),s("div",Ot,[s("span",At,c(a.user.u_full_name),1),e[17]||(e[17]=s("span",{class:"text-text-secondary"}," changed ",-1)),s("span",jt,c(a.field_name),1)])]))),128))])])])):P.value==="comments"?(i(),l("section",Kt,[(i(!0),l(E,null,$(u.value??[],a=>{var U,C,re;return i(),l("div",{key:a._id,class:"rounded-xl border border-orchit-white/10 bg-orchit-white/5 p-4 hover:bg-orchit-white/7 transition"},[s("div",Nt,[s("div",Ht,c(Fe((U=a.created_by)==null?void 0:U.u_full_name)),1),s("div",Qt,[s("div",Rt,c((C=a.created_by)==null?void 0:C.u_full_name),1),s("div",Wt,c($e(a.created_at)),1)]),qe(a)?(i(),l("div",Gt,[O.value!==a._id?(i(),l("button",{key:0,class:"text-xs text-accent hover:underline",onClick:x=>Ae(a)},"Edit",8,Jt)):S("",!0),s("button",{class:"text-xs text-red-400 hover:underline",onClick:x=>Ke(a)},"Delete",8,Xt)])):S("",!0)]),h(F,{name:"fade",mode:"out-in"},{default:y(()=>[O.value!==a._id?(i(),l("p",{key:`c-view-${a._id}`,class:"text-[15px] leading-6"},c(a.comment_text),1)):(i(),l("div",{key:`c-edit-${a._id}`,class:"space-y-2"},[j(s("textarea",{"onUpdate:modelValue":e[4]||(e[4]=x=>V.value=x),rows:"3",class:"w-full p-3 rounded-lg bg-bg-input/80 border border-orchit-white/10 focus:ring-2 focus:ring-accent/40 outline-none"},null,512),[[X,V.value]]),s("div",Yt,[h(Y,{variant:"secondary",size:"sm",onClick:G},{default:y(()=>e[20]||(e[20]=[K("Cancel")])),_:1,__:[20]}),h(Y,{class:"btn",size:"sm",onClick:x=>je(a),disabled:!V.value.trim()||g(ie)},{default:y(()=>[K(c(g(ie)?"Saving…":"Save"),1)]),_:2},1032,["onClick","disabled"])])]))]),_:2},1024),(re=a==null?void 0:a.attachments)!=null&&re.length?(i(),l("div",Zt,[(i(!0),l(E,null,$(a.attachments,(x,Ge)=>(i(),l("a",{key:Ge,href:x.url,target:"_blank",class:"group flex items-center gap-2 rounded-lg border border-orchit-white/10 bg-orchit-white/5 px-2 py-1 hover:bg-orchit-white/10 transition"},[e[21]||(e[21]=s("i",{class:"fa-regular fa-file text-text-secondary group-hover:text-text-primary transition"},null,-1)),s("span",ts,c(x==null?void 0:x.name),1)],8,es))),128))])):S("",!0)])}),128)),s("div",ss,[j(s("textarea",{"onUpdate:modelValue":e[5]||(e[5]=a=>L.value=a),rows:"3",class:"w-full p-3 bg-transparent outline-none text-sm",placeholder:"Write a comment"},null,512),[[X,L.value]]),s("div",as,[s("input",{type:"file",multiple:"",onChange:Qe,class:"text-xs text-text-secondary file:mr-3 file:px-3 file:py-1.5 file:rounded-md file:border file:border-orchit-white/10 file:bg-orchit-white/10 hover:file:bg-orchit-white/15 file:text-text-primary transition"},null,32),h(Y,{variant:"primary",size:"sm",onClick:Re,disabled:!L.value.trim()&&!B.value.length},{default:y(()=>[K(c(g(Be)?"Posting…":"Post"),1)]),_:1},8,["disabled"])])])])):(i(),l("section",os,[s("div",is," Files attached to this "+c(((m=d.details)==null?void 0:m.type)??"item")+". ",1),s("div",ls,[(i(!0),l(E,null,$(Ne.value,a=>(i(),l("div",{key:a._id,class:"rounded-2xl overflow-hidden border border-orchit-white/10 bg-orchit-white/5 hover:bg-orchit-white/8 transition group"},[s("div",ns,[a.kind==="image"?(i(),l("div",ds,[s("img",{src:a.url,class:"w-full h-40 object-cover group-hover:scale-[1.02] transition"},null,8,rs)])):a.kind==="video"?(i(),l("div",cs,[s("video",{src:a.url,controls:"",class:"w-full h-40 object-cover"},null,8,us)])):(i(),l("div",ms,e[22]||(e[22]=[s("i",{class:"fa-regular fa-file text-3xl text-text-secondary"},null,-1)]))),s("div",ps,[s("div",vs,c(a.name),1),s("div",hs,c(a.kind),1)])]),s("div",fs,[s("a",{href:a.url,target:"_blank",rel:"noopener",class:"w-full inline-flex items-center justify-center gap-2 h-9 rounded-lg bg-accent text-orchit-white text-sm hover:opacity-90 transition"},e[23]||(e[23]=[s("i",{class:"fa-regular fa-arrow-up-right-from-square"},null,-1),K(" View ")]),8,xs)])]))),128))])]))]}),_:1})])],512),[[tt,d.showPanel]])]),_:1}))}}),Is=at(gs,[["__scopeId","data-v-24d1369f"]]);export{Is as default};
