import{R as ce,S as me,T as G,c as M,p as P,d as Y,r as d,N as Ue,j as B,o as D,F as te,f as t,i,k as ne,t as j,w as T,h as K,W as lt,n as O,v as Ne,x as nt,e as R,_ as Q,ae as ye,B as W,g as I,ak as ee,J as De,X as be,D as ue,bd as ke,P as it,be as ze,U as _e,y as xe,an as rt,am as dt,bf as ut,M as Me,Z as ct,$ as mt,ac as We,bg as pt,I as we}from"./index-D1HTj25s.js";import{_ as ft}from"./DropMenu.vue_vue_type_script_setup_true_lang-C-JhxsID.js";import{_ as Ie}from"./ConfirmDeleteModal.vue_vue_type_script_setup_true_lang-BrcenpPn.js";import{u as vt,M as le,_ as gt,a as _t,b as yt,c as ve,P as ge,d as bt}from"./useLocalWorkflowState-BAP3KRWt.js";import{L as wt}from"./Loader-BTAH0BHr.js";import{_ as he}from"./BaseTextAreaField.vue_vue_type_script_setup_true_lang-DGkEUZs3.js";import"./favicon-BAFXWHLW.js";const kt=[{id:"col-1",_id:"col-1",sheet_id:"sheet-1",workspace_id:"workspace-1",title:"Active Processes",order:0,created_at:"2024-01-15T10:00:00Z",processes:[]},{id:"col-3",_id:"col-3",sheet_id:"sheet-2",workspace_id:"workspace-1",title:"Development",order:0,created_at:"2024-01-20T14:30:00Z",processes:[]},{id:"col-4",_id:"col-4",sheet_id:"sheet-3",workspace_id:"workspace-1",title:"Design Queue",order:0,created_at:"2024-02-01T09:15:00Z",processes:[]}],xt=[{id:"process-1",_id:"process-1",workspace_id:"workspace-1",title:"General Process",description:"Standard workflow for handling general tasks and approvals",column_id:"col-1",order:0,status_count:4,transition_count:5,created_at:"2024-01-15T10:00:00Z"},{id:"process-4",_id:"process-4",workspace_id:"workspace-1",title:"Feature Development",description:"End-to-end feature development workflow",column_id:"col-3",order:0,status_count:6,transition_count:8,created_at:"2024-01-20T14:30:00Z"},{id:"process-5",_id:"process-5",workspace_id:"workspace-1",title:"Bug Triage",description:"Process for triaging and prioritizing bugs",column_id:"col-3",order:1,status_count:4,transition_count:5,created_at:"2024-01-21T16:00:00Z"},{id:"process-6",_id:"process-6",workspace_id:"workspace-1",title:"Design Review",description:"Comprehensive design review and feedback process",column_id:"col-4",order:0,status_count:4,transition_count:6,created_at:"2024-02-01T09:15:00Z"}],ht=[{id:"status-1",process_id:"process-1",status_name:"Create",category:"todo",status_color:"#6b7280",position_x:100,position_y:200,order:0,is_initial:!0,is_final:!1},{id:"status-2",process_id:"process-1",status_name:"To Do",category:"todo",status_color:"#6b7280",position_x:300,position_y:200,order:1,is_initial:!1,is_final:!1},{id:"status-3",process_id:"process-1",status_name:"In Progress",category:"inprogress",status_color:"#3b82f6",position_x:500,position_y:200,order:2,is_initial:!1,is_final:!1},{id:"status-4",process_id:"process-1",status_name:"Done",category:"done",status_color:"#10b981",position_x:700,position_y:200,order:3,is_initial:!1,is_final:!0}],Ct=[{id:"transition-1",process_id:"process-1",from_status_id:"status-1",to_status_id:"status-2",transition_label:"Start Task",rules:[]},{id:"transition-2",process_id:"process-1",from_status_id:"status-2",to_status_id:"status-3",transition_label:"Begin Work",rules:[]},{id:"transition-3",process_id:"process-1",from_status_id:"status-3",to_status_id:"status-4",transition_label:"Complete",rules:[]},{id:"transition-4",process_id:"process-1",from_status_id:"status-3",to_status_id:"status-2",transition_label:"Need Revision",rules:[]},{id:"transition-5",process_id:"process-1",from_status_id:"status-2",to_status_id:"status-4",transition_label:"Skip to Done",rules:[]}],Le=(v,u={})=>me({queryKey:["process-sheets",v],queryFn:({signal:l})=>G({url:`workspace/${v}/process-flow`,method:"GET",signal:l}),...u}),Vt=(v,u={})=>me({queryKey:["process-workflow",v],queryFn:({signal:l})=>G({url:`workspace/${v}/process-flow/transitions`,method:"GET",signal:l}),...u}),St=(v,u,l={})=>me({queryKey:["process-columns",v,u],queryFn:()=>{const p=P(u),o=kt.filter(c=>c.sheet_id===p);return Promise.resolve(o.map(c=>({...c,processes:xt.filter(m=>m.column_id===c.id)})))},enabled:M(()=>!!P(u)),...l}),$t=(v={})=>ce({key:["create-process-column"]},{mutationFn:u=>G({url:"/workspace/process-columns",method:"POST",data:u.payload}),...v}),Tt=(v={})=>ce({key:["delete-process-column"]},{mutationFn:u=>G({url:`/workspace/process-columns/${u.id}`,method:"DELETE"}),...v}),Pt=(v={})=>ce({key:["create-process"]},{mutationFn:u=>G({url:"/workspace/processes",method:"POST",data:u.payload}),...v}),Et=(v={})=>ce({key:["delete-process"]},{mutationFn:u=>G({url:`/workspace/processes/${u.id}`,method:"DELETE"}),...v}),At=(v,u={})=>me({queryKey:["workflow-data",v],queryFn:()=>{const l=P(v),p=ht.filter(c=>c.process_id===l),o=Ct.filter(c=>c.process_id===l);return Promise.resolve({statuses:p,transitions:o})},enabled:!!P(v),...u}),Ut=(v,u={})=>ce({key:["create-transition"]},{mutationFn:l=>G({url:`workspace/${v}/process-flow/transitions`,method:"POST",data:l.payload}),...u}),Nt=(v,u={})=>me({queryKey:["process-status",v],queryFn:({signal:l})=>G({url:`common/cardstatus-process?workspace_id=${v}`,method:"GET",signal:l}),...u}),Dt={class:"flex justify-between gap-2 items-start"},zt={class:"flex items-start gap-3 flex-1"},Mt={class:"flex-1 min-w-0"},Wt={class:"text-sm font-semibold text-text-primary leading-tight mb-1"},It={key:0,class:"text-xs text-text-secondary line-clamp-2"},Lt=Y({__name:"ProcessKanbanCard",props:{ticket:{},index:{}},emits:["click"],setup(v,{emit:u}){const l=v,p=u,o=d(!1),c=Ue();function m(){return[{label:"Open Workflow Builder",action:()=>{p("click")},icon:{prefix:"fa-regular",iconName:"fa-diagram-project"}},{label:"Delete Process",danger:!0,action:()=>{o.value=!0},icon:{prefix:"fa-regular",iconName:"fa-trash"}}]}const{mutate:_,isPending:C}=Et({onSuccess:()=>{o.value=!1,c.invalidateQueries({queryKey:["process-columns"]})}}),w=()=>{_({id:l.ticket._id})};return(k,f)=>{var L,z;return D(),B(te,null,[t("div",{onClick:f[1]||(f[1]=V=>k.$emit("click")),class:"bg-bg-card rounded-lg p-4 shadow-sm cursor-pointer hover:shadow-md transition-all duration-200 border border-border hover:border-accent"},[t("div",Dt,[t("div",zt,[f[5]||(f[5]=t("div",{class:"w-10 h-10 bg-accent/20 flex justify-center items-center rounded-lg"},[t("i",{class:"fa-solid fa-diagram-project text-accent"})],-1)),t("div",Mt,[t("h3",Wt,j(((L=k.ticket)==null?void 0:L.title)??`Process ${k.index+1}`),1),(z=k.ticket)!=null&&z.description?(D(),B("p",It,j(k.ticket.description),1)):ne("",!0)])]),i(ft,{onClick:f[0]||(f[0]=K(()=>{},["stop"])),items:m()},{trigger:T(()=>f[6]||(f[6]=[t("i",{class:"cursor-pointer fa-solid fa-ellipsis text-text-secondary hover:text-text-primary"},null,-1)])),_:1},8,["items"])])]),i(Ie,{onClick:f[2]||(f[2]=K(()=>{},["stop"])),modelValue:o.value,"onUpdate:modelValue":f[3]||(f[3]=V=>o.value=V),title:"Delete Process",itemLabel:"process",itemName:k.ticket.title,requireMatchText:k.ticket.title,confirmText:"Delete Process",cancelText:"Cancel",size:"md",loading:P(C),onConfirm:w,onCancel:f[4]||(f[4]=()=>{o.value=!1})},null,8,["modelValue","itemName","requireMatchText","loading"])],64)}}}),qt={class:"workflow-wrap"},Bt={class:"relative min-w-[90px] px-2 py-1 rounded-md text-sm"},Ft={class:"flex justify-between items-center gap-2"},jt={class:"truncate"},Ht={class:"flex items-center gap-1.5"},Kt=["onClick"],Ot=["onClick"],Zt={class:"modal border border-border !bg-bg-body text-text-primary"},Rt={class:"modal-actions mt-4"},Qt={class:"modal border border-border !bg-bg-body text-text-primary"},Gt={class:"modal-actions mt-4"},Yt=Y({__name:"WorkflowCanvas",emits:["edit:node"],setup(v,{expose:u,emit:l}){const p=d(!1),o=d(""),c=d(null),m=d([]),_=d([]),{setNodes:C,updateNode:w,addEdges:k,setEdges:f,removeEdges:L,onNodesInitialized:z,fitView:V,updateNodeInternals:r,addNodes:S,project:H,getNodes:U,getEdges:g,zoomIn:y,zoomOut:b}=vt(),{workspaceId:E}=lt(),{refetch:Z}=Le(E.value),{data:se,isSuccess:ie}=Nt(E.value),{data:J,isSuccess:$,isPending:x,isFetching:X,refetch:oe}=Vt(E.value);function h(e){return{id:e.id,type:e.type??"default",position:e.position,data:e.data,style:e.style}}function n(e){const s=(e??"arrow").toLowerCase();return s==="arrow"?le.Arrow:s==="arrowclosed"?le.ArrowClosed:le.Arrow}function q(e){var N,A,de,F,fe;const s=e.markerEnd||e.marker_end,a=e.style;return{id:e.id||((N=e.flow_metadata)==null?void 0:N.transition_id),type:e.type??"step",source:e.source??((de=(A=e.flow_metadata)==null?void 0:A.source_node)==null?void 0:de.id),target:e.target??((fe=(F=e.flow_metadata)==null?void 0:F.target_node)==null?void 0:fe.id),sourceHandle:e.sourceHandle??e.source_handle,targetHandle:e.targetHandle??e.target_handle,label:e.label,data:e.data,animated:e.animated??!1,style:a?{...a,strokeWidth:Number(a.strokeWidth??2)}:void 0,markerEnd:s?{type:n(s.type),color:s.color,width:Number(s.width??18),height:Number(s.height??18)}:void 0}}O([()=>ie.value,()=>$.value,X],async([e,s])=>{var a,N;if(e&&s&&se.value&&!((a=J.value)!=null&&a.raw_transitions.nodes)){const A=se.value.map((F,fe)=>({id:String(F._id),type:F.type??"default",position:{x:300*fe,y:34},data:{label:F.value,status:"To Do"}}));await ee(),C(A),await ee(),m.value=A,await ee();const de=[];for(let F=0;F<A.length-1;F++)de.push({id:`edge-${A[F].id}-${A[F+1].id}`,source:A[F].id,target:A[F+1].id,type:"step",label:"Auto Transition",animated:!1,style:{stroke:"#1152de",strokeWidth:2},markerEnd:{type:le.Arrow,color:"#1152de",width:18,height:18},sourceHandle:"out-right",targetHandle:"in-left"});(N=J.value)!=null&&N.raw_transitions.nodes||f(de),await ee()}},{immediate:!0}),O(J,async e=>{if(!(e!=null&&e.raw_transitions))return;const s=e.raw_transitions,a=Array.isArray(s.nodes)?s.nodes.map(h):[],N=Array.isArray(s.edges)?s.edges.map(q):[];await ee(),C(a),z(async()=>{a.forEach(A=>r(A.id)),f(N),V({padding:.8}),await ee()})},{immediate:!0});function Ce(e){re.value=e,ae.value="",pe.value=!0}function Ve(){var A;if(!re.value)return;const e=re.value,s=ae.value.trim()||"Transition",a=`${e.source}-${e.target}-${((A=crypto.randomUUID)==null?void 0:A.call(crypto))??Math.random()}`,N={...e,id:a,type:"step",label:s,data:{name:s},style:{stroke:"#1152de",strokeWidth:2},markerEnd:{type:le.Arrow,color:"#1152de",width:18,height:18},sourceHandle:e.sourceHandle,targetHandle:e.targetHandle};k(N),pe.value=!1,re.value=null,ae.value=""}function Se(){pe.value=!1,re.value=null,ae.value=""}const{mutate:qe,isPending:$e}=Ut(E.value,{onSuccess:()=>{oe(),Z()}}),Be={type:"default",animated:!1,style:{strokeWidth:2},markerEnd:{type:le.Arrow,color:"#3b82f6",width:18,height:18},labelBgPadding:[6,2],labelBgBorderRadius:6,updatable:!0},Fe=d(!1),je=d(""),pe=d(!1),ae=d(""),re=d(null),He=l;function Ke(){je.value="",Fe.value=!0}function Oe(e,s){const a=U.value.find(N=>N.id===e);console.log(a,">>>>"),a&&He("edit:node",{id:e,...a.data,status_color:s.status||"#6b7280"})}function Ze(e,s){s&&w(e,a=>({...a,data:{...a.data,label:s.name,status:s.category},style:{border:"2px solid #64748b",borderRadius:"8px",background:s.status_color}})),ee()}async function Re(e){const a=(()=>{var A;return((A=crypto.randomUUID)==null?void 0:A.call(crypto))??`n-${Date.now()}-${Math.random()}`})(),N=H({x:e.position_x,y:e.position_y});S({id:a,position:N,data:{label:e.name,status:e.status_name},style:{border:"2px solid #64748b",borderRadius:"8px",background:e.status_color}})}u({openCreateNodeModal:Ke,handleAddNode:Re,saveWorkflow:Te,isSaving:$e,handleConfirmEdit:Ze});function Qe(e){if(!e)return;const s=String(e).toLowerCase();return s.includes("arrowclosed")?"arrowclosed":s.includes("arrow")?"arrow":s.includes("circle")?"circle":s.includes("square")?"square":s.includes("diamond")?"diamond":s.includes("dot")?"dot":"arrow"}function Ge(e){return{id:e.id,type:e.type??"default",position:e.position,data:e.data,style:e.style}}function Ye(e){const s=e.markerEnd,a=s?(()=>{const N=typeof s=="string"?s:s.type;return{type:Qe(N),color:typeof s=="string"?void 0:s.color,width:typeof s=="string"?void 0:Number(s.width??18),height:typeof s=="string"?void 0:Number(s.height??18)}})():void 0;return{id:e.id,type:e.type??"step",source:e.source,target:e.target,source_handle:e.sourceHandle,target_handle:e.targetHandle,label:e.label,data:e.data,style:e.style?{...e.style,strokeWidth:Number(e.style.strokeWidth??2)}:void 0,marker_end:a,animated:!!e.animated}}function Je(){const e=U.value,s=g.value;return{workspace_id:E.value,flow_diagram:{nodes:e.map(Ge),edges:s.map(Ye)}}}function Te(){const e=Je();console.log(" >>> saving workspace",e),qe({payload:e})}window.addEventListener("beforeunload",()=>{if(!$e.value)try{Te()}catch{}});function Xe(e){var s;console.log(e,"edge"),c.value=e.id,o.value=String(e.label??((s=e.data)==null?void 0:s.name)??""),p.value=!0}function Pe(){if(!c.value)return;const e=o.value.trim();f(s=>s.map(a=>{var N;return a.id===c.value?{...a,label:e||a.label,data:{...a.data??{},name:e||((N=a.data)==null?void 0:N.name)}}:a})),p.value=!1,c.value=null,o.value=""}function et(){c.value&&(L([c.value]),p.value=!1,c.value=null,o.value="")}function tt(e){C(s=>s.filter(a=>a.id!==e)),f(s=>s.filter(a=>a.source!==e&&a.target!==e)),c.value=null}function st(e){window.confirm("Are you sure you want to delete this status? All transitions will also be removed.")&&tt(e)}function ot(e){const{edge:s,connection:a}=e;!s||!a||f(N=>N.map(A=>A.id===s.id?{...A,source:a.source,target:a.target,sourceHandle:a.sourceHandle,targetHandle:a.targetHandle}:A))}function Ee(){p.value=!1,c.value=null,o.value=""}function at({event:e,edge:s}){console.log(">>> click",s),Xe(s),e.stopPropagation()}Ne(()=>{window.addEventListener("workflow:zoom",Ae)}),nt(()=>{window.removeEventListener("workflow:zoom",Ae)});function Ae(e){const s=e.detail;s&&(s.action==="in"&&y(),s.action==="out"&&b(),s.action==="reset"&&V({padding:.8}))}return(e,s)=>(D(),B(te,null,[t("div",qt,[P(x)||P(X)?(D(),R(wt,{key:0})):(D(),R(P(gt),{key:1,nodes:m.value,"onUpdate:nodes":s[0]||(s[0]=a=>m.value=a),edges:_.value,"onUpdate:edges":s[1]||(s[1]=a=>_.value=a),"default-edge-options":Be,"nodes-draggable":!0,"nodes-connectable":!0,"elements-selectable":!0,"fit-view-on-init":"",onConnect:Ce,onEdgeClick:at,onEdgeUpdate:ot,"edge-updater-radius":20},{"node-default":T(({id:a,data:N})=>[t("div",Bt,[t("div",Ft,[t("span",jt,j(N.label),1),t("div",Ht,[t("i",{class:"fa-solid fa-edit cursor-pointer text-xs opacity-70 hover:opacity-100",onClick:K(A=>Oe(a,N),["stop"])},null,8,Kt),t("i",{class:"fa-solid fa-trash cursor-pointer text-red-500/80 hover:text-red-500 text-xs",onClick:K(A=>st(a),["stop"])},null,8,Ot)])]),i(P(ve),{id:"in-top",type:"target",position:P(ge).Top},null,8,["position"]),i(P(ve),{id:"out-right",type:"source",position:P(ge).Right},null,8,["position"]),i(P(ve),{id:"out-bottom",type:"source",position:P(ge).Bottom},null,8,["position"]),i(P(ve),{id:"in-left",type:"target",position:P(ge).Left},null,8,["position"])])]),default:T(()=>[i(P(_t)),i(P(yt))]),_:1},8,["nodes","edges"])),pe.value?(D(),B("div",{key:2,class:"modal-backdrop",onClick:K(Se,["self"])},[t("div",Zt,[s[6]||(s[6]=t("h3",null,"Name this transition",-1)),i(Q,{modelValue:ae.value,"onUpdate:modelValue":s[2]||(s[2]=a=>ae.value=a),placeholder:"e.g., Start work, Complete",onKeyup:ye(Ve,["enter"]),autofocus:""},null,8,["modelValue"]),t("div",Rt,[i(W,{size:"sm",onClick:Ve},{default:T(()=>s[4]||(s[4]=[I("Add Transition")])),_:1,__:[4]}),i(W,{variant:"secondary",size:"sm",onClick:Se},{default:T(()=>s[5]||(s[5]=[I("Cancel")])),_:1,__:[5]})])])])):ne("",!0)]),p.value?(D(),B("div",{key:0,class:"modal-backdrop",onClick:K(Ee,["self"])},[t("div",Qt,[s[10]||(s[10]=t("h3",null,"Edit transition",-1)),i(Q,{modelValue:o.value,"onUpdate:modelValue":s[3]||(s[3]=a=>o.value=a),placeholder:"Transition name",onKeyup:ye(Pe,["enter"]),autofocus:""},null,8,["modelValue"]),t("div",Gt,[i(W,{size:"sm",onClick:Pe},{default:T(()=>s[7]||(s[7]=[I("Save")])),_:1,__:[7]}),i(W,{variant:"secondary",size:"sm",onClick:Ee},{default:T(()=>s[8]||(s[8]=[I("Cancel")])),_:1,__:[8]}),i(W,{size:"sm",variant:"danger",onClick:et},{default:T(()=>s[9]||(s[9]=[I(" Delete ")])),_:1,__:[9]})])])])):ne("",!0)],64))}}),Jt=De(Yt,[["__scopeId","data-v-256ee1ae"]]),Xt={class:"p-6"},es={class:"text-lg font-semibold text-text-primary mb-4"},ts={class:"space-y-4"},ss={class:"flex items-center gap-3"},os={class:"mt-6 flex justify-end gap-2"},as=Y({__name:"AddStatusModal",props:{modelValue:{type:Boolean},processId:{},editingStatus:{}},emits:["update:modelValue","status:added","edit:node"],setup(v,{emit:u}){const l=v,p=u,o=M({get:()=>l.modelValue,set:U=>p("update:modelValue",U)}),c=ze("workflowState"),m=d(""),_=d("todo"),C=d("#6b7280"),w=d(!1),k=d(!1),f=d(!1),L={todo:"#6b7280",inprogress:"#3b82f6",done:"#10b981"},z=M(()=>!!l.editingStatus);O(l,()=>{var U,g,y,b,E,Z;m.value=((U=l.editingStatus)==null?void 0:U.label)||"",_.value=((g=l.editingStatus)==null?void 0:g.status)||"todo",C.value=((y=l.editingStatus)==null?void 0:y.status_color)||((b=l.editingStatus)==null?void 0:b.status)||"#6b7280",w.value=((E=l.editingStatus)==null?void 0:E.is_initial)||!1,k.value=((Z=l.editingStatus)==null?void 0:Z.is_final)||!1});function V(){C.value=L[_.value]}function r(){}function S(){m.value="",o.value=!1}function H(){if(m.value.trim()){f.value=!0;try{if(z.value){console.log("editing mode on ");const U={...l.editingStatus,name:m.value.trim(),category:_.value,status_color:C.value,is_initial:w.value,is_final:k.value,status_name:m.value.trim()};c.updateStatus(l.editingStatus.id,U),p("edit:node",l.editingStatus.id,U)}else{console.log("editing mode close ");const U={process_id:l.processId,name:m.value.trim(),category:_.value,status_color:C.value,is_initial:w.value,is_final:k.value,status_name:_.value.trim(),position_x:Math.random()*400+100,position_y:Math.random()*300+100,order:c.localStatuses.value.length};c.addStatus(U),p("status:added",U)}S()}catch{_e.error(z.value?"Failed to update status":"Failed to add status")}finally{f.value=!1}}}return(U,g)=>(D(),R(be,{modelValue:o.value,"onUpdate:modelValue":g[4]||(g[4]=y=>o.value=y),size:"md"},{default:T(()=>[t("div",Xt,[t("h3",es,j(z.value?"Edit Status":"Add Status"),1),t("div",ts,[t("div",null,[g[5]||(g[5]=t("label",{class:"text-sm font-medium text-text-primary mb-1.5 block"},"Status Name",-1)),i(Q,{modelValue:m.value,"onUpdate:modelValue":g[0]||(g[0]=y=>m.value=y),placeholder:"e.g., To Do, In Progress, Done",autofocus:!0},null,8,["modelValue"])]),t("div",null,[g[7]||(g[7]=t("label",{class:"text-sm font-medium text-text-primary mb-1.5 block"},"Category",-1)),ue(t("select",{"onUpdate:modelValue":g[1]||(g[1]=y=>_.value=y),onChange:V,class:"w-full px-3 py-2 text-sm bg-bg-surface border border-border rounded-md text-text-primary focus:outline-none focus:ring-1 focus:ring-accent"},g[6]||(g[6]=[t("option",{value:"todo"},"To Do",-1),t("option",{value:"inprogress"},"In Progress",-1),t("option",{value:"done"},"Done",-1)]),544),[[ke,_.value]]),g[8]||(g[8]=t("p",{class:"text-xs text-text-secondary mt-1"},"Category cannot be changed after creation",-1))]),t("div",null,[g[9]||(g[9]=t("label",{class:"text-sm font-medium text-text-primary mb-1.5 block"},"Status Color",-1)),t("div",ss,[ue(t("input",{type:"color","onUpdate:modelValue":g[2]||(g[2]=y=>C.value=y),onInput:r,class:"h-10 w-20 rounded border border-border cursor-pointer"},null,544),[[it,C.value]]),i(Q,{modelValue:C.value,"onUpdate:modelValue":g[3]||(g[3]=y=>C.value=y),placeholder:"#3b82f6",class:"flex-1"},null,8,["modelValue"])])])]),t("div",os,[i(W,{onClick:S,variant:"secondary"},{default:T(()=>g[10]||(g[10]=[I("Cancel")])),_:1,__:[10]}),i(W,{onClick:H,disabled:!m.value.trim()||f.value},{default:T(()=>[I(j(f.value?z.value?"Updating...":"Adding...":z.value?"Update Status":"Add Status"),1)]),_:1},8,["disabled"])])])]),_:1},8,["modelValue"]))}}),ls={class:"p-6"},ns={class:"space-y-4"},is=["value"],rs=["value"],ds={class:"mt-6 flex justify-end gap-2"},us=Y({__name:"AddTransitionModal",props:{modelValue:{type:Boolean},processId:{},statuses:{}},emits:["update:modelValue","transition:added"],setup(v,{emit:u}){const l=v,p=u,o=M({get:()=>l.modelValue,set:V=>p("update:modelValue",V)}),c=ze("workflowState"),m=d(""),_=d(""),C=d(""),w=d(""),k=d(!1),f=M(()=>m.value&&_.value&&m.value!==_.value);O(()=>l.modelValue,V=>{V&&(m.value="",_.value="",C.value="",w.value="")});function L(){o.value=!1}function z(){if(f.value){if(c.hasTransition(m.value,_.value)){_e.error("A transition already exists between these statuses");return}k.value=!0;try{const V={process_id:l.processId,from_status_id:m.value,to_status_id:_.value,transition_label:C.value.trim(),rules:w.value?[{description:w.value}]:[]};c.addTransition(V),_e.success("Transition added successfully"),p("transition:added"),L()}catch{_e.error("Failed to add transition")}finally{k.value=!1}}}return(V,r)=>(D(),R(be,{modelValue:o.value,"onUpdate:modelValue":r[4]||(r[4]=S=>o.value=S),size:"md"},{default:T(()=>[t("div",ls,[r[12]||(r[12]=t("h3",{class:"text-lg font-semibold text-text-primary mb-4"},"Add Transition",-1)),t("div",ns,[t("div",null,[r[6]||(r[6]=t("label",{class:"text-sm font-medium text-text-primary mb-1.5 block"},"From Status",-1)),ue(t("select",{"onUpdate:modelValue":r[0]||(r[0]=S=>m.value=S),class:"w-full px-3 py-2 text-sm bg-bg-surface border border-border rounded-md text-text-primary focus:outline-none focus:ring-1 focus:ring-accent"},[r[5]||(r[5]=t("option",{value:""},"Select source status",-1)),(D(!0),B(te,null,xe(V.statuses,S=>(D(),B("option",{key:S.id,value:S.id},j(S.status_name),9,is))),128))],512),[[ke,m.value]])]),t("div",null,[r[8]||(r[8]=t("label",{class:"text-sm font-medium text-text-primary mb-1.5 block"},"To Status",-1)),ue(t("select",{"onUpdate:modelValue":r[1]||(r[1]=S=>_.value=S),class:"w-full px-3 py-2 text-sm bg-bg-surface border border-border rounded-md text-text-primary focus:outline-none focus:ring-1 focus:ring-accent"},[r[7]||(r[7]=t("option",{value:""},"Select destination status",-1)),(D(!0),B(te,null,xe(V.statuses,S=>(D(),B("option",{key:S.id,value:S.id},j(S.status_name),9,rs))),128))],512),[[ke,_.value]])]),t("div",null,[r[9]||(r[9]=t("label",{class:"text-sm font-medium text-text-primary mb-1.5 block"},"Transition Label (Optional)",-1)),i(Q,{modelValue:C.value,"onUpdate:modelValue":r[2]||(r[2]=S=>C.value=S),placeholder:"e.g., Start work, Complete, Approve"},null,8,["modelValue"])]),t("div",null,[r[10]||(r[10]=t("label",{class:"text-sm font-medium text-text-primary mb-1.5 block"},"Rules (Optional)",-1)),i(he,{modelValue:w.value,"onUpdate:modelValue":r[3]||(r[3]=S=>w.value=S),placeholder:"Add any rules or conditions for this transition"},null,8,["modelValue"])])]),t("div",ds,[i(W,{onClick:L,variant:"secondary"},{default:T(()=>r[11]||(r[11]=[I("Cancel")])),_:1,__:[11]}),i(W,{onClick:z,disabled:!f.value||k.value},{default:T(()=>[I(j(k.value?"Adding...":"Add Transition"),1)]),_:1},8,["disabled"])])])]),_:1},8,["modelValue"]))}}),cs={class:"relative flex h-full w-full flex-col bg-bg-body",role:"dialog","aria-modal":"true",tabindex:"0"},ms={class:"border-b border-border px-[20px] sm:px-6 py-4 overflow-x-auto"},ps={class:"flex items-center justify-between max-w-content gap-3"},fs={class:"flex items-center gap-4"},vs={class:"flex items-center gap-2 text-lg sm:text-xl font-semibold text-text-primary text-nowrap"},gs={class:"flex cursor-pointer items-center gap-2 text-sm text-text-secondary text-nowrap"},_s={class:"flex items-center gap-3"},ys={class:"relative flex-1 overflow-hidden"},bs={key:0,class:"flex items-center justify-center h-full bg-bg-surface"},ws={class:"flex items-center justify-end sm:justify-between border-t border-border bg-bg-surface sm:px-6 py-3"},ks={class:"flex items-center gap-2"},xs=Y({__name:"WorkflowBuilderModal",props:{modelValue:{type:Boolean},process:{}},emits:["update:modelValue","close"],setup(v,{emit:u}){const l=v,p=u,o=d(null),c=d(!0),m=d(!1),_=d(!1),C=M(()=>l.modelValue),w=M(()=>{var h,n;return((h=l.process)==null?void 0:h._id)??((n=l.process)==null?void 0:n.id)??""}),k=M(()=>{var h;return((h=l.process)==null?void 0:h.title)??"Process"}),{data:f,refetch:L,isLoading:z}=At(w),V=bt();ut("workflowState",V);const r=d(null),S=M(()=>V.localStatuses.value);O(C,h=>{h&&w.value&&L()}),O(()=>f.value,h=>{h&&C.value&&V.initialize(h.statuses,h.transitions)},{immediate:!0});const H=M(()=>{var h;return!!((h=o.value)!=null&&h.isSaving)}),U=M(()=>{if(H.value)return"Updating...";const h=V.changeCount.value||0;return h>0?`Update workflow (${h})`:"Update workflow"});function g(){V.hasChanges.value&&!window.confirm("You have unsaved changes. Are you sure you want to close?")||(p("update:modelValue",!1),p("close"))}function y(){r.value="",m.value=!0}function b(){_.value=!0}function E(){L()}function Z(){var h;(h=o.value)==null||h.saveWorkflow()}function se(){window.dispatchEvent(new CustomEvent("workflow:zoom",{detail:{action:"in"}}))}function ie(){window.dispatchEvent(new CustomEvent("workflow:zoom",{detail:{action:"out"}}))}function J(){window.dispatchEvent(new CustomEvent("workflow:zoom",{detail:{action:"reset"}}))}function $(h){var n,q;m.value=!1,(q=(n=o.value)==null?void 0:n.handleAddNode)==null||q.call(n,h),r.value=null}function x(){_.value=!1}function X(h){r.value=h,m.value=!0}const oe=(h,n)=>{var q;(q=o.value)==null||q.handleConfirmEdit(h,n)};return(h,n)=>(D(),B(te,null,[i(rt,{name:"fade"},{default:T(()=>[C.value?(D(),B("div",{key:0,class:"fixed inset-0 z-50 bottom-[60px] sm:bottom-0 flex items-center justify-center bg-black/80 backdrop-blur-sm",onKeydown:ye(g,["esc"])},[t("div",cs,[t("div",ms,[t("div",ps,[t("div",fs,[t("h2",vs,[n[3]||(n[3]=t("i",{class:"fa-solid fa-diagram-project text-accent","aria-hidden":"true"},null,-1)),I(" Workflow for "+j(k.value),1)]),t("label",gs,[ue(t("input",{type:"checkbox","onUpdate:modelValue":n[0]||(n[0]=q=>c.value=q),class:"rounded"},null,512),[[dt,c.value]]),n[4]||(n[4]=t("span",null,"Show transition labels",-1))])]),t("div",_s,[i(W,{variant:"secondary",size:"sm",onClick:y},{default:T(()=>n[5]||(n[5]=[t("i",{class:"fa-solid fa-plus mr-2","aria-hidden":"true"},null,-1),I(" Add Status ")])),_:1,__:[5]}),i(W,{variant:"primary",size:"sm",disabled:H.value,onClick:Z},{default:T(()=>[I(j(U.value),1)]),_:1},8,["disabled"]),t("button",{class:"text-xl text-text-secondary hover:text-text-primary",onClick:g,"aria-label":"Close"},n[6]||(n[6]=[t("i",{class:"fa-solid fa-times","aria-hidden":"true"},null,-1)]))])])]),t("div",ys,[P(z)?(D(),B("div",bs,n[7]||(n[7]=[t("div",{class:"flex flex-col items-center gap-4"},[t("div",{class:"animate-spin rounded-full h-12 w-12 border-4 border-accent border-t-transparent"}),t("p",{class:"text-sm text-text-secondary"},"Loading workflow...")],-1)]))):w.value?(D(),R(Jt,{key:1,ref_key:"Canvas",ref:o,"process-id":w.value,"show-transition-labels":c.value,"onUpdate:workflow":E,"onAdd:status":y,"onAdd:transition":b,"onEdit:node":X},null,8,["process-id","show-transition-labels"])):ne("",!0)]),t("div",ws,[n[11]||(n[11]=t("div",{class:"hidden sm:flex items-center gap-4 text-sm text-text-secondary"},[t("span",{class:"flex items-center gap-2"},[t("i",{class:"fa-solid fa-hand-pointer","aria-hidden":"true"}),I(" Click and drag to pan ")]),t("span",{class:"flex items-center gap-2"},[t("i",{class:"fa-solid fa-magnifying-glass","aria-hidden":"true"}),I(" Scroll to zoom ")])],-1)),t("div",ks,[i(W,{variant:"ghost",size:"sm",onClick:ie},{default:T(()=>n[8]||(n[8]=[t("i",{class:"fa-solid fa-minus","aria-hidden":"true"},null,-1),t("span",{class:"sr-only"},"Zoom out",-1)])),_:1,__:[8]}),i(W,{variant:"ghost",size:"sm",onClick:J},{default:T(()=>n[9]||(n[9]=[t("i",{class:"fa-solid fa-expand","aria-hidden":"true"},null,-1),t("span",{class:"sr-only"},"Reset zoom",-1)])),_:1,__:[9]}),i(W,{variant:"ghost",size:"sm",onClick:se},{default:T(()=>n[10]||(n[10]=[t("i",{class:"fa-solid fa-plus","aria-hidden":"true"},null,-1),t("span",{class:"sr-only"},"Zoom in",-1)])),_:1,__:[10]})])])])],32)):ne("",!0)]),_:1}),i(as,{modelValue:m.value,"onUpdate:modelValue":n[1]||(n[1]=q=>m.value=q),"process-id":w.value,"editing-status":r.value,"onStatus:added":$,"onEdit:node":oe},null,8,["modelValue","process-id","editing-status"]),i(us,{modelValue:_.value,"onUpdate:modelValue":n[2]||(n[2]=q=>_.value=q),"process-id":w.value,statuses:S.value,"onTransition:added":x},null,8,["modelValue","process-id","statuses"])],64))}}),hs=De(xs,[["__scopeId","data-v-78fab420"]]),Cs={class:"px-6"},Vs={class:"flex items-center gap-3 pt-4"},Ss=Y({__name:"CreateProcessSheetModal",props:{modelValue:{type:Boolean}},emits:["update:modelValue","created"],setup(v,{emit:u}){const l=u,p=d(""),o=d(""),c=d(!1),m=async()=>{p.value.trim()&&(c.value=!0,setTimeout(()=>{const C={_id:`sheet-${Date.now()}`,title:p.value,description:o.value,icon:{prefix:"fa-solid",iconName:"fa-diagram-project"},workspace_id:"workspace-1",created_at:new Date().toISOString()};l("created",C),p.value="",o.value="",c.value=!1,_()},500))},_=()=>{l("update:modelValue",!1),p.value="",o.value=""};return(C,w)=>(D(),R(be,{modelValue:C.modelValue,"onUpdate:modelValue":_,size:"md"},{default:T(()=>[t("div",Cs,[w[3]||(w[3]=t("h2",{class:"text-xl font-semibold text-text-primary mb-4"},"Create Process Sheet",-1)),t("form",{onSubmit:K(m,["prevent"]),class:"space-y-4"},[i(Q,{modelValue:p.value,"onUpdate:modelValue":w[0]||(w[0]=k=>p.value=k),label:"Sheet Title",placeholder:"e.g., General Process",required:"",autofocus:!0},null,8,["modelValue"]),i(he,{modelValue:o.value,"onUpdate:modelValue":w[1]||(w[1]=k=>o.value=k),label:"Description",placeholder:"Describe this process sheet...",rows:"3"},null,8,["modelValue"]),t("div",Vs,[i(W,{type:"submit",variant:"primary",size:"md",disabled:!p.value.trim()||c.value},{default:T(()=>[I(j(c.value?"Creating...":"Create Sheet"),1)]),_:1},8,["disabled"]),i(W,{type:"button",variant:"secondary",size:"md",onClick:_},{default:T(()=>w[2]||(w[2]=[I(" Cancel ")])),_:1,__:[2]})])],32)])]),_:1},8,["modelValue"]))}}),$s={class:"px-6 relative"},Ts={class:"flex items-center gap-3 pt-4 pb-2"},Ps=Y({__name:"AddProcessModal",props:{modelValue:{type:Boolean}},emits:["update:modelValue","created"],setup(v,{emit:u}){const l=u,{workspaceId:p}=Me(),o=d({name:"",description:"",module_id:null,sheet_id:null,process_type_id:null}),{data:c,isLoading:m}=ct(p),_=M(()=>{var y;return(((y=c.value)==null?void 0:y.modules)||[]).map(b=>{var E;return{_id:b._id,title:((E=b.variables)==null?void 0:E["module-title"])||b.module_id}})}),{data:C,isLoading:w}=mt({workspace_id:p,workspace_module_id:M(()=>o.value.module_id)},{enabled:M(()=>!!o.value.module_id)});We(()=>{console.log(C.value,"these are all workspace data")});const k=M(()=>(C.value||[]).map(y=>{var b;return{_id:y._id,title:(b=y.variables)==null?void 0:b["sheet-title"]}})),{data:f,isLoading:L}=pt(p,M(()=>o.value.module_id),d("card-type"),{enabled:M(()=>!!o.value.module_id&&!!o.value.sheet_id)}),z=M(()=>{var y;return(((y=f.value)==null?void 0:y.values)||[]).map(b=>({_id:b._id,title:b.value||b.title}))});O(()=>o.value.module_id,()=>{o.value.sheet_id=null,o.value.process_type_id=null}),O(()=>o.value.sheet_id,()=>{o.value.process_type_id=null});const V=M(()=>o.value.name.trim().length>0&&o.value.module_id&&o.value.sheet_id&&o.value.process_type_id),{mutate:r,isPending:S}=Pt({onSuccess:y=>{l("created",y),U()}}),H=()=>{if(!V.value)return;const y={workspace_id:p.value,title:o.value.name,description:o.value.description,workspace_module_id:o.value.module_id,sheet_id:o.value.sheet_id,process_type_id:o.value.process_type_id};r({payload:y})},U=()=>{l("update:modelValue",!1),g()},g=()=>{o.value={name:"",description:"",module_id:null,sheet_id:null,process_type_id:null}};return(y,b)=>(D(),R(be,{modelValue:y.modelValue,"onUpdate:modelValue":U,size:"md"},{default:T(()=>[t("div",$s,[b[6]||(b[6]=t("h2",{class:"text-xl font-semibold text-text-primary mb-6"},"Add New Process",-1)),t("form",{onSubmit:K(H,["prevent"]),class:"space-y-5"},[i(Q,{modelValue:o.value.name,"onUpdate:modelValue":b[0]||(b[0]=E=>o.value.name=E),label:"Process Name",placeholder:"Enter process name",required:"",autofocus:!0},null,8,["modelValue"]),i(he,{modelValue:o.value.description,"onUpdate:modelValue":b[1]||(b[1]=E=>o.value.description=E),label:"Process Description",placeholder:"Enter process description",rows:"3"},null,8,["modelValue"]),i(we,{modelValue:o.value.module_id,"onUpdate:modelValue":b[2]||(b[2]=E=>o.value.module_id=E),options:_.value,label:"Select Module",placeholder:"Select a module",required:"",loading:P(m)},null,8,["modelValue","options","loading"]),i(we,{modelValue:o.value.sheet_id,"onUpdate:modelValue":b[3]||(b[3]=E=>o.value.sheet_id=E),options:k.value,label:"Select Sheet",placeholder:"Select a sheet",required:"",disabled:!o.value.module_id,loading:P(w)},null,8,["modelValue","options","disabled","loading"]),i(we,{modelValue:o.value.process_type_id,"onUpdate:modelValue":b[4]||(b[4]=E=>o.value.process_type_id=E),options:z.value,label:"Select Process Type",placeholder:"Select process type",required:"",disabled:!o.value.sheet_id,loading:P(L)},null,8,["modelValue","options","disabled","loading"]),t("div",Ts,[i(W,{type:"submit",variant:"primary",size:"md",disabled:!V.value||P(S),class:"flex-1"},{default:T(()=>[I(j(P(S)?"Creating...":"Create Process"),1)]),_:1},8,["disabled"]),i(W,{type:"button",variant:"secondary",size:"md",onClick:U,class:"flex-1"},{default:T(()=>b[5]||(b[5]=[I(" Cancel ")])),_:1,__:[5]})])],32)])]),_:1},8,["modelValue"]))}}),Es={class:"flex-auto flex-grow h-full bg-bg-card rounded-lg border border-border overflow-x-auto flex-col flex items-start"},As={class:"max-w-82 p-4 bg-bg-body rounded-md m-4"},Us={key:0,class:"bg-bg-body rounded-lg p-4"},Ns={class:"flex items-center mt-3 gap-3"},Bs=Y({__name:"Process",setup(v){const u=d(!1),l=d(!1),p=d(),{workspaceId:o}=Me(),{data:c}=Le(o.value),m=d("sheet-1");O(c,$=>{var x;$&&$.length>0&&!m.value&&(m.value=(x=$[0])==null?void 0:x._id)});const _=d(!1),{mutate:C,isPending:w}=$t({onSuccess:$=>{k.value=[...k.value||[],{...$,cards:[]}],r.value="",V.value=!1}}),k=d([]),{data:f}=St(o.value,m);We(()=>{console.log(f.value,"this is the list ")}),O(f,$=>{$&&(k.value=$.map(x=>({...x,_id:x.id,cards:x.processes||[]})))}),Ne(()=>{f.value&&(k.value=f.value.map($=>({...$,_id:$.id,cards:$.processes||[]})))});const L=d(null),z=d(!1),V=d(!1),r=d("");function S(){V.value=!V.value}function H(){const $=r.value.trim();$&&U($)}const U=$=>{const x={workspace_id:o.value,sheet_id:m.value,title:$,order:k.value.length};C({payload:x})},g=Ue(),{mutate:y,isPending:b}=Tt({onSuccess:()=>{l.value=!1,g.invalidateQueries({queryKey:["process-columns"]})}}),E=()=>{var $;y({id:($=p.value)==null?void 0:$.columnId})},Z=$=>{L.value=$,z.value=!0},se=()=>{z.value=!1,L.value=null},ie=()=>{_.value=!1,g.invalidateQueries({queryKey:["process-sheets"]})},J=()=>{u.value=!1,g.invalidateQueries({queryKey:["process-columns"]})};return($,x)=>{var X,oe,h;return D(),B(te,null,[t("div",Es,[t("div",As,[(D(!0),B(te,null,xe((X=k.value[0])==null?void 0:X.cards,(n,q)=>(D(),R(Lt,{onClick:Ce=>Z(n),key:q,ticket:n,index:q},null,8,["onClick","ticket","index"]))),128))]),t("button",{class:"max-w-82 ms-4 text-sm text-text-primary py-2.5 font-medium flex items-center justify-center w-full gap-2 bg-bg-body rounded-lg cursor-pointer",onClick:x[0]||(x[0]=n=>u.value=!0)}," + Add New Process "),t("div",{class:"min-w-[328px]",onClick:x[2]||(x[2]=K(()=>{},["stop"]))},[V.value?(D(),B("div",Us,[i(Q,{autofocus:!0,modelValue:r.value,"onUpdate:modelValue":x[1]||(x[1]=n=>r.value=n),placeholder:"Add New Column",onKeyup:ye(H,["enter"])},null,8,["modelValue"]),x[9]||(x[9]=t("p",{class:"text-xs mt-1.5"},"You can add details while editing",-1)),t("div",Ns,[i(W,{onClick:H,variant:"primary",class:"px-3 py-1 bg-accent cursor-pointer text-white rounded"},{default:T(()=>[I(j(P(w)?"Adding...":"Add Column"),1)]),_:1}),t("i",{class:"fa-solid fa-close cursor-pointer",onClick:S})])])):ne("",!0)])]),i(Ie,{onClick:x[3]||(x[3]=K(()=>{},["stop"])),modelValue:l.value,"onUpdate:modelValue":x[4]||(x[4]=n=>l.value=n),title:"Delete Column",itemLabel:"column",itemName:(oe=p.value)==null?void 0:oe.title,requireMatchText:(h=p.value)==null?void 0:h.title,confirmText:"Delete column",cancelText:"Cancel",size:"md",loading:P(b),onConfirm:E,onCancel:x[5]||(x[5]=()=>{l.value=!1})},null,8,["modelValue","itemName","requireMatchText","loading"]),i(hs,{modelValue:z.value,"onUpdate:modelValue":x[6]||(x[6]=n=>z.value=n),process:L.value,onClose:se},null,8,["modelValue","process"]),i(Ss,{modelValue:_.value,"onUpdate:modelValue":x[7]||(x[7]=n=>_.value=n),onCreated:ie},null,8,["modelValue"]),i(Ps,{modelValue:u.value,"onUpdate:modelValue":x[8]||(x[8]=n=>u.value=n),onCreated:J},null,8,["modelValue"])],64)}}});export{Bs as default};
