import{D as J,P as ze,E as z,m as O,d as je,r as m,l as I,p as qe,Q as Ae,as as Ke,c as y,bh as Ne,I as Qe,a as He,w as _,y as F,z as Re,b as s,g as v,T as U,h as l,L as ne,f as le,a5 as W,t as r,i as D,F as w,x as We,v as V,B as G,e as M,N as ie,o as n,_ as Ge}from"./index-4VVrnSvV.js";import{B as Je}from"./BaseRichTextEditor-C_fmFArb.js";import{h as Xe,u as Ye}from"./KanbanSkeleton-B1eNe9RJ.js";import{T as Ze}from"./TypeChanger-DKNxskcB.js";import{_ as et}from"./BaseSelectField.vue_vue_type_script_setup_true_lang-BVbjuD4Z.js";import{D as de}from"./DatePicker-DpMfeDLB.js";import{_ as tt}from"./AssigmentDropdown.vue_vue_type_script_setup_true_lang-BsIan_I4.js";import{u as st}from"./useQueryParams-bRK_EXJo.js";import{b as at}from"./useCommon-Fwq2lbvO.js";import{S as ot}from"./SwitchTab-BcL5JRCs.js";import"./BaseTextField.vue_vue_type_script_setup_true_lang-BOTvTtsA.js";import"./info-DjaLHeD_.js";import"./index-D77Hbchx.js";const nt=(d,p={})=>ze({queryKey:["comments",d],queryFn:({signal:j})=>z({url:`workspace/cards/${O(d)}/comments`,method:"GET",signal:j}),...p,enabled:!!d}),lt=(d={})=>J({key:["add-comment"]},{mutationFn:p=>z({url:`workspace/cards/${p.id}/comments`,method:"POST",data:p.payload}),...d}),it=(d={})=>J({key:["delete-comment"]},{mutationFn:p=>z({url:`/workspace/comments/${p.id}`,method:"DELETE",data:p.payload}),...d}),dt=(d={})=>J({key:["update-comment"]},{mutationFn:p=>z({url:`workspace/comments/${p.id}`,method:"PUT",data:p.payload}),...d}),rt={class:"flex flex-col max-w-[380px] min-w-[380px] h-full overflow-y-auto bg-gradient-to-b from-bg-card/95 to-bg-card/90 backdrop-blur rounded-2xl shadow-[0_10px_40px_-10px_rgba(0,0,0,.5)] border border-white/5 overflow-hidden",role:"complementary","aria-label":"Details panel"},ut={class:"sticky top-0 z-10 bg-transparent border-b border-white/5 px-6 py-4 flex items-center justify-between"},ct={class:"py-5 px-6 flex flex-col gap-5 flex-grow"},mt={class:"capitalize"},vt=["onKeydown"],pt=["innerHTML"],ft={key:1,class:"opacity-60"},xt={key:"tab-details",class:"space-y-6"},gt={class:"grid grid-cols-2 gap-4 text-sm"},_t={class:"rounded-xl bg-white/5 border border-white/10 p-4"},bt={class:"mt-1 font-medium"},ht={class:"rounded-xl bg-white/5 border border-white/10 p-4"},yt={class:"mt-1 font-medium"},wt={class:"rounded-2xl border border-white/10 bg-white/5 p-4 grid grid-cols-1 sm:grid-cols-2 gap-4"},kt={class:"space-y-2"},Ct={class:"space-y-2"},Dt={class:"h-10 px-3 flex items-center gap-2 rounded-lg bg-bg-input border border-white/10"},St={class:"space-y-2"},Et={key:0,class:"text-xs text-red-400 mt-1"},Tt={class:"space-y-2 sm:col-span-2"},It={key:0,class:"space-y-2 sm:col-span-1"},Ut={class:"text-xs uppercase tracking-wider text-text-secondary"},Vt={key:1},Pt={class:"relative border-l border-white/10 pl-5 space-y-4"},$t={class:"rounded-xl bg-white/5 border border-white/10 p-3 hover:bg-white/7 transition"},Bt={class:"font-semibold"},Lt={class:"font-semibold"},Ft={key:"tab-comments",class:"space-y-4"},Mt={class:"flex items-center gap-3 mb-2"},Ot={class:"h-8 w-8 rounded-full bg-accent/15 text-accent flex items-center justify-center text-xs font-semibold"},zt={class:"flex-1"},jt={class:"text-sm font-medium"},qt={class:"text-xs text-text-secondary"},At={key:0,class:"flex items-center gap-2"},Kt=["onClick"],Nt=["onClick"],Qt={class:"flex items-center gap-2 justify-end"},Ht={key:0,class:"mt-3 grid grid-cols-2 gap-2"},Rt=["href"],Wt={class:"text-xs truncate"},Gt={class:"rounded-xl border border-white/10 bg-white/5 overflow-hidden"},Jt={class:"flex items-center justify-between p-2 border-t border-white/10"},Xt={key:"tab-attachments",class:"space-y-3"},Yt={class:"text-xs text-text-secondary"},Zt={class:"grid sm:grid-cols-2 gap-4"},es={class:"p-3"},ts={key:0,class:"rounded-lg overflow-hidden"},ss=["src"],as={key:1,class:"rounded-lg overflow-hidden"},os=["src"],ns={key:2,class:"h-40 rounded-lg bg-black/5 grid place-items-center"},ls={class:"mt-3"},is={class:"font-medium truncate"},ds={class:"text-xs text-text-secondary capitalize"},rs={class:"p-3 pt-0"},us=["href"],cs=je({__name:"SidePanel",props:{pin:{type:Boolean,default:!1},showPanel:{type:Boolean,default:!0},details:{type:Object,default:()=>({})}},emits:["close","update:details","comment:post","priority:change"],setup(d,{emit:p}){var ae,oe;const{workspaceId:j}=st(),i=d,S=m("details"),re=[{label:"Details",value:"details"},{label:"Comments",value:"comments"},{label:"History",value:"history"},{label:"Attachment",value:"attachment"}],P=m(!1),b=m(i.details["card-title"]??"");I(()=>i.details["card-title"],t=>{b.value=t});const q=m(null);function ue(){P.value=!0,ie(()=>{var t,e;(t=q.value)==null||t.focus(),(e=q.value)==null||e.select()})}function X(){b.value.trim()||(b.value=i.details["card-title"]??""),h.mutate({card_id:i.details._id,variables:{"card-title":b.value.trim()}}),P.value=!1}const k=m(i.details["card-description"]);I(()=>i.details,()=>{k.value=i.details["card-description"]});const $=m(!1),A=m(null);function ce(t){var u,x;const e=(u=t==null?void 0:t.querySelector)==null?void 0:u.call(t,".ProseMirror");if(!e)return;e.focus();const o=(x=window.getSelection)==null?void 0:x.call(window),a=document.createRange();a.selectNodeContents(e),a.collapse(!1),o==null||o.removeAllRanges(),o==null||o.addRange(a)}async function me(){$.value=!0,await ie(),ce(A.value||void 0)}function Y(t){h.mutate({card_id:i.details._id,attachments:t??[],variables:{"card-description":k.value}}),$.value=!1}function Z(t){var o;if(!$.value)return;const e=t.target;(o=A.value)!=null&&o.contains(e)||Y()}qe(()=>document.addEventListener("mousedown",Z)),Ae(()=>document.removeEventListener("mousedown",Z));const ee=Ke({posted_on:((ae=i.details)==null?void 0:ae.posted_on)??((oe=i.details)==null?void 0:oe.created_at)??new Date().toISOString()}),ve=y({get:()=>new Date(ee.posted_on).toISOString().slice(0,10),set:t=>{ee.posted_on=new Date(t+"T00:00:00").toISOString()}}),{data:K}=Xe(j.value),N=m(i.details.workspace_lane_id??"");I(()=>i.details.workspace_lane_id,t=>{N.value=t});const pe=y(()=>((K==null?void 0:K.value)??[]).map(t=>{var e;return{_id:t._id,title:((e=t==null?void 0:t.variables)==null?void 0:e["lane-title"])??String(t._id)}}));function fe(t){N.value=t,h.mutate({card_id:i.details._id,workspace_lane_id:t})}const f=m({startDate:i.details["start-date"],endDate:i.details["end-date"]}),xe=y(()=>i.details["start-date"]);I(xe,t=>{f.value={...f.value,startDate:t}});const Q=y(()=>f!=null&&f.value.startDate&&f.value.endDate&&f.value.endDate<f.value.startDate?"End date cannot be before start date":""),ge=t=>h.mutate({card_id:i.details._id,variables:{"start-date":t}}),_e=t=>h.mutate({card_id:i.details._id,variables:{"end-date":t}}),be=y(()=>i.details.assigned_to),he=t=>{var e;h.mutate({card_id:i.details._id,assigned_to:(e=t==null?void 0:t.user_info)==null?void 0:e._id})},c=m([]),ye=y(()=>{var t;return(t=i.details)==null?void 0:t._id}),{data:te}=nt(ye);I(()=>te.value,()=>{var t;c.value=(t=te.value)==null?void 0:t.comments});const{mutate:we,isPending:ke}=lt({onSuccess:t=>{E.value="",T.value=[],c.value=[...c.value,t]}}),E=m(""),Ce=t=>(t??"").split(" ").map(e=>e[0]).filter(Boolean).slice(0,2).join("").toUpperCase(),De=t=>t?new Date(t).toLocaleString():"",{data:Se}=Ne(),Ee=t=>{var e;return((e=t==null?void 0:t.created_by)==null?void 0:e._id)===Se.value},B=m(null),C=m(""),{mutate:Te,isPending:se}=dt(),{mutate:Ie}=it();function Ue(t){B.value=t._id,C.value=t.comment_text??""}function H(){B.value=null,C.value="",P.value=!1}function Ve(t){const e=C.value.trim();if(!e)return;const o=c.value.findIndex(u=>u._id===t._id),a=o>-1?{...c.value[o]}:null;o>-1&&(c.value[o]={...c.value[o],comment_text:e}),Te({id:t._id,payload:{comment_text:e}},{onError:()=>{o>-1&&a&&(c.value[o]=a)},onSuccess:u=>{o>-1&&(c.value[o]=u??c.value[o]),H()}})}function Pe(t){const e=c.value.findIndex(a=>a._id===t._id),o=e>-1?c.value[e]:null;e>-1&&c.value.splice(e,1),Ie({id:t._id},{onError:()=>{o&&c.value.splice(e,0,o)}})}const $e=y(()=>{var t;return(((t=i.details)==null?void 0:t.attachments)??[]).map(e=>{var o;return{_id:e._id??e.id??((o=crypto.randomUUID)==null?void 0:o.call(crypto))??Math.random(),name:e.name??e.filename??"file",url:e.url,kind:(e.type??e.kind??"").toLowerCase().includes("image")?"image":(e.type??e.kind??"").toLowerCase().includes("video")?"video":"file"}})}),R=Qe(),h=Ye({onSuccess:()=>{R.invalidateQueries({queryKey:["get-sheets"]}),R.invalidateQueries({queryKey:["sheet-list"]}),R.invalidateQueries({queryKey:["roles"]})}}),T=m([]),{mutate:Be}=at({onSuccess:t=>{T.value=[t]}});function Le(t){const e=t.target.files;Array.from(e).forEach(o=>{const a=new FormData;a.append("file",o),Be(a)})}function Fe(){const t=E.value.trim();!t&&!T.value.length||we({id:i.details._id,payload:{comment_text:t,attachments:T.value.map(e=>({name:e.data.name,url:e.data.url}))}})}function Me(t,e){var a,u;((u=(((a=i.details)==null?void 0:a.variables)??[]).find(x=>x.slug===e))==null?void 0:u.value)!==t&&h.mutate({card_id:i.details._id,variables:{[e]:t}})}return(t,e)=>(n(),He(U,{name:"panel",appear:""},{default:_(()=>[F(s("div",rt,[s("div",ut,[e[7]||(e[7]=s("h5",{class:"text-[18px] font-semibold tracking-tight"},"Details",-1)),s("button",{class:"p-2 rounded-xl hover:bg-white/5 active:scale-[.98] transition",onClick:e[0]||(e[0]=o=>t.$emit("close")),"aria-label":"Close details"},e[6]||(e[6]=[s("i",{class:"fa-solid fa-xmark text-xl"},null,-1)]))]),s("div",ct,[s("div",mt,[v(U,{name:"fade-scale",mode:"out-in"},{default:_(()=>[P.value?F((n(),l("input",{key:"title-edit",ref_key:"titleInput",ref:q,"onUpdate:modelValue":e[1]||(e[1]=o=>b.value=o),onBlur:X,onKeydown:[ne(le(X,["prevent"]),["enter"]),ne(le(H,["prevent"]),["esc"])],class:"w-full text-2xl font-semibold rounded-xl px-3 py-2 bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-accent/40 transition",type:"text","aria-label":"Edit title"},null,40,vt)),[[W,b.value]]):(n(),l("h1",{key:"title-view",class:"text-2xl font-semibold tracking-tight cursor-text rounded-lg px-2 py-1 hover:bg-white/5 transition",onClick:ue,"aria-label":"Card title"},r(b.value||"Untitled"),1))]),_:1})]),s("div",null,[e[8]||(e[8]=s("h3",{class:"mb-2 text-base font-semibold tracking-wide px-1"},"Description",-1)),v(U,{name:"fade-scale",mode:"out-in"},{default:_(()=>[$.value?(n(),l("div",{key:"desc-edit",ref_key:"descEditorWrap",ref:A,class:"rounded-xl overflow-hidden border border-white/10 shadow-sm"},[v(Je,{modelValue:k.value,"onUpdate:modelValue":e[2]||(e[2]=o=>k.value=o),onFocusOut:Y},null,8,["modelValue"])],512)):(n(),l("div",{key:"desc-view",class:"text-[15px] leading-6 text-text-secondary whitespace-pre-wrap cursor-text rounded-xl px-4 py-3 border border-white/10 bg-white/5 hover:border-white/20 transition",onClick:me},[k.value?(n(),l("div",{key:0,innerHTML:k.value},null,8,pt)):(n(),l("span",ft,"Click to add a description…"))]))]),_:1})]),v(ot,{modelValue:S.value,"onUpdate:modelValue":e[3]||(e[3]=o=>S.value=o),options:re,size:"md"},null,8,["modelValue"]),v(U,{name:"section",mode:"out-in"},{default:_(()=>{var o;return[S.value==="details"?(n(),l("section",xt,[s("div",gt,[s("div",_t,[e[9]||(e[9]=s("div",{class:"text-xs uppercase tracking-wider text-text-secondary"},"Posted On",-1)),s("div",bt,r(ve.value),1)]),s("div",ht,[e[10]||(e[10]=s("div",{class:"text-xs uppercase tracking-wider text-text-secondary"},"ID",-1)),s("div",yt,r(d.details["card-code"]),1)])]),s("div",wt,[s("div",kt,[e[11]||(e[11]=s("div",{class:"text-xs uppercase tracking-wider text-text-secondary"},"Lane",-1)),v(et,{size:"sm",options:pe.value,placeholder:"Select lane",allowCustom:!1,"model-value":N.value,"onUpdate:modelValue":fe},null,8,["options","model-value"])]),d.pin?D("",!0):(n(),l(w,{key:0},[s("div",Ct,[e[13]||(e[13]=s("div",{class:"text-xs uppercase tracking-wider text-text-secondary"},"Start Date",-1)),s("div",Dt,[e[12]||(e[12]=s("i",{class:"fa-regular fa-calendar"},null,-1)),v(de,{placeholder:"Set start date",class:"w-full","model-value":f.value.startDate,"emit-as":"ymd","onUpdate:modelValue":ge},null,8,["model-value"])])]),s("div",St,[e[15]||(e[15]=s("div",{class:"text-xs uppercase tracking-wider text-text-secondary"},"Target End",-1)),s("div",{class:We(["h-10 px-3 flex items-center gap-2 rounded-lg bg-bg-input border transition-colors",Q.value?"border-red-500":"border-white/10"])},[e[14]||(e[14]=s("i",{class:"fa-regular fa-calendar"},null,-1)),v(de,{placeholder:"Set end date",class:"w-full","model-value":f.value.endDate,"emit-as":"ymd","onUpdate:modelValue":_e},null,8,["model-value"])],2),Q.value?(n(),l("p",Et,r(Q.value),1)):D("",!0)]),s("div",Tt,[e[16]||(e[16]=s("div",{class:"text-xs uppercase tracking-wider text-text-secondary"},"Assign",-1)),v(tt,{onAssign:he,assigneeId:be.value,seat:d.details.seat},null,8,["assigneeId","seat"])])],64)),(n(!0),l(w,null,V(d.details.variables,(a,u)=>{var x;return n(),l(w,{key:`var-${u}`},[(a==null?void 0:a.type)==="Select"?(n(),l("div",It,[s("div",Ut,r(a.title),1),v(Ze,{default:a==null?void 0:a.value,data:a==null?void 0:a.data,cardId:(x=d.details)==null?void 0:x._id,onOnselect:L=>Me(L,a.slug)},null,8,["default","data","cardId","onOnselect"])])):D("",!0)],64)}),128))])])):S.value==="history"?(n(),l("section",Vt,[s("div",null,[e[19]||(e[19]=s("h3",{class:"text-sm font-semibold tracking-wide mb-2"},"History",-1)),s("ol",Pt,[(n(!0),l(w,null,V(d.details.history,(a,u)=>(n(),l("li",{key:u,class:"group"},[e[18]||(e[18]=s("span",{class:"absolute -left-[5px] top-0 w-2 h-2 rounded-full bg-accent/70 ring-4 ring-accent/10"},null,-1)),s("div",$t,[s("span",Bt,r(a.user.u_full_name),1),e[17]||(e[17]=s("span",{class:"text-text-secondary"}," changed ",-1)),s("span",Lt,r(a.field_name),1)])]))),128))])])])):S.value==="comments"?(n(),l("section",Ft,[(n(!0),l(w,null,V(c.value??[],a=>{var u,x,L;return n(),l("div",{key:a._id,class:"rounded-xl border border-white/10 bg-white/5 p-4 hover:bg-white/7 transition"},[s("div",Mt,[s("div",Ot,r(Ce((u=a.created_by)==null?void 0:u.u_full_name)),1),s("div",zt,[s("div",jt,r((x=a.created_by)==null?void 0:x.u_full_name),1),s("div",qt,r(De(a.created_at)),1)]),Ee(a)?(n(),l("div",At,[B.value!==a._id?(n(),l("button",{key:0,class:"text-xs text-accent hover:underline",onClick:g=>Ue(a)},"Edit",8,Kt)):D("",!0),s("button",{class:"text-xs text-red-400 hover:underline",onClick:g=>Pe(a)},"Delete",8,Nt)])):D("",!0)]),v(U,{name:"fade",mode:"out-in"},{default:_(()=>[B.value!==a._id?(n(),l("p",{key:`c-view-${a._id}`,class:"text-[15px] leading-6"},r(a.comment_text),1)):(n(),l("div",{key:`c-edit-${a._id}`,class:"space-y-2"},[F(s("textarea",{"onUpdate:modelValue":e[4]||(e[4]=g=>C.value=g),rows:"3",class:"w-full p-3 rounded-lg bg-bg-input/80 border border-white/10 focus:ring-2 focus:ring-accent/40 outline-none"},null,512),[[W,C.value]]),s("div",Qt,[v(G,{variant:"secondary",size:"sm",onClick:H},{default:_(()=>e[20]||(e[20]=[M("Cancel")])),_:1,__:[20]}),v(G,{class:"btn",size:"sm",onClick:g=>Ve(a),disabled:!C.value.trim()||O(se)},{default:_(()=>[M(r(O(se)?"Saving…":"Save"),1)]),_:2},1032,["onClick","disabled"])])]))]),_:2},1024),(L=a==null?void 0:a.attachments)!=null&&L.length?(n(),l("div",Ht,[(n(!0),l(w,null,V(a.attachments,(g,Oe)=>(n(),l("a",{key:Oe,href:g.url,target:"_blank",class:"group flex items-center gap-2 rounded-lg border border-white/10 bg-white/5 px-2 py-1 hover:bg-white/10 transition"},[e[21]||(e[21]=s("i",{class:"fa-regular fa-file text-text-secondary group-hover:text-text-primary transition"},null,-1)),s("span",Wt,r(g==null?void 0:g.name),1)],8,Rt))),128))])):D("",!0)])}),128)),s("div",Gt,[F(s("textarea",{"onUpdate:modelValue":e[5]||(e[5]=a=>E.value=a),rows:"3",class:"w-full p-3 bg-transparent outline-none text-sm",placeholder:"Write a comment"},null,512),[[W,E.value]]),s("div",Jt,[s("input",{type:"file",multiple:"",onChange:Le,class:"text-xs text-text-secondary file:mr-3 file:px-3 file:py-1.5 file:rounded-md file:border file:border-white/10 file:bg-white/10 hover:file:bg-white/15 file:text-text-primary transition"},null,32),v(G,{variant:"primary",size:"sm",onClick:Fe,disabled:!E.value.trim()&&!T.value.length},{default:_(()=>[M(r(O(ke)?"Posting…":"Post"),1)]),_:1},8,["disabled"])])])])):(n(),l("section",Xt,[s("div",Yt," Files attached to this "+r(((o=d.details)==null?void 0:o.type)??"item")+". ",1),s("div",Zt,[(n(!0),l(w,null,V($e.value,a=>(n(),l("div",{key:a._id,class:"rounded-2xl overflow-hidden border border-white/10 bg-white/5 hover:bg-white/8 transition group"},[s("div",es,[a.kind==="image"?(n(),l("div",ts,[s("img",{src:a.url,class:"w-full h-40 object-cover group-hover:scale-[1.02] transition"},null,8,ss)])):a.kind==="video"?(n(),l("div",as,[s("video",{src:a.url,controls:"",class:"w-full h-40 object-cover"},null,8,os)])):(n(),l("div",ns,e[22]||(e[22]=[s("i",{class:"fa-regular fa-file text-3xl text-text-secondary"},null,-1)]))),s("div",ls,[s("div",is,r(a.name),1),s("div",ds,r(a.kind),1)])]),s("div",rs,[s("a",{href:a.url,target:"_blank",rel:"noopener",class:"w-full inline-flex items-center justify-center gap-2 h-9 rounded-lg bg-accent text-white text-sm hover:opacity-90 transition"},e[23]||(e[23]=[s("i",{class:"fa-regular fa-arrow-up-right-from-square"},null,-1),M(" View ")]),8,us)])]))),128))])]))]}),_:1})])],512),[[Re,d.showPanel]])]),_:1}))}}),Ds=Ge(cs,[["__scopeId","data-v-1b9d24fa"]]);export{Ds as default};
