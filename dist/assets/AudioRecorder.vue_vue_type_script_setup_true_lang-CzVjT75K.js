import{bv as Z,a as ee,d as te,r as o,n as W,am as ae,j as l,z as O,C as ne,k as y,D as se,f as k,t as j,p as A,g as re,o as c,ah as oe}from"./index-DM5NKZ0I.js";const ie=Z.create({baseURL:void 0,headers:{"Content-Type":"application/json",Authorization:"Bearer undefined"}}),le=(C={})=>ee({mutationFn:async _=>{const a=new FormData;return a.append("file",_),a.append("model","whisper-1"),a.append("response_format","json"),(await ie.post("/audio/transcriptions",a,{headers:{Authorization:"Bearer undefined","Content-Type":"multipart/form-data"}})).data.text},...C}),ce={key:0,class:"absolute top-3 left-2 text-xs text-accent ml-2 mt-1"},ue={key:0,class:"w-8 h-8 aspect-square rounded-lg cursor-pointer bg-accent p-2 flex items-center justify-center"},de={key:1,class:"w-8 h-8 aspect-square rounded-lg bg-accent flex justify-center items-center text-center cursor-pointer"},ve={key:2,class:"text-text-secondary"},fe={key:3,class:"text-red-500"},he={key:4,class:"text-white mt-2 text-sm"},pe=3,Y=200,ge=te({__name:"AudioRecorder",props:{class:{type:String,default:""}},emits:["transcribed","update:isRecording","update:hasAudio"],setup(C,{emit:_}){const a=_,z=C,w=o(0);let b=null;const F=o(null),s=o(null),r=o(!1),L=o(null);let S=[],u=null;const{mutate:X,data:T,isPending:G,isError:J}=le({onSuccess:e=>{a("update:isRecording",!1),a("update:hasAudio",!1),a("transcribed",e)}});W(T,e=>{e&&a("transcribed",e)});let d=null,f,x,q,H=0;const i=o(null),I=o(!1),B=o(0),h=new Array(Y).fill(0),N=()=>{if(!L.value||!f)return;const e=L.value,t=e.getContext("2d");if(!t)return;f.getByteFrequencyData(x);const p=x.reduce((U,E)=>U+E,0)/x.length/255*.8;H++,H%pe===0&&(h.push(p),h.length>Y&&h.shift()),t.clearRect(0,0,e.width,e.height);const v=e.height/2;t.strokeStyle="var(--accent)",t.setLineDash([2,2]),t.beginPath(),t.moveTo(0,v),t.lineTo(e.width,v),t.stroke(),t.setLineDash([]);const m=1,g=m+1,D=e.width-h.length*g;t.fillStyle="var(--accent)",h.forEach((U,E)=>{const M=U*e.height*1,$=D+E*g;t.fillRect($,v-M,m,M||5),t.fillRect($,v,m,M||5)}),q=requestAnimationFrame(N)},P=()=>{cancelAnimationFrame(q),d==null||d.close(),d=null},K=async()=>{if(r.value)u==null||u.stop(),P(),r.value=!1,b&&(clearInterval(b),b=null);else{const e=await navigator.mediaDevices.getUserMedia({audio:!0});u=new MediaRecorder(e),S=[],u.ondataavailable=n=>{n.data.size>0&&S.push(n.data)},u.onstop=()=>{const n=new Blob(S,{type:"audio/webm"});F.value=n,s.value=URL.createObjectURL(n);const p=new File([n],"recording.webm",{type:"audio/webm"});X(p),i.value=new Audio(s.value),i.value.addEventListener("timeupdate",()=>{B.value=Math.floor(i.value.currentTime)}),i.value.addEventListener("ended",()=>{I.value=!1,B.value=0}),s.value=URL.createObjectURL(n),i.value=new Audio(s.value),i.value.addEventListener("timeupdate",()=>{B.value=Math.floor(i.value.currentTime)}),i.value.addEventListener("ended",()=>{I.value=!1})},d=new AudioContext;const t=d.createMediaStreamSource(e);f=d.createAnalyser(),f.fftSize=2048,x=new Uint8Array(f.frequencyBinCount),t.connect(f),N(),u.start(),r.value=!0,w.value=0,b=setInterval(()=>{w.value++},1e3)}},V=o(null),Q=()=>{if(!V.value||!F.value)return;const e=V.value,t=e.getContext("2d");if(!t)return;e.width=e.clientWidth,e.height=e.clientHeight,t.clearRect(0,0,e.width,e.height);const n=e.height/2,p=300,v=2,m=2;for(let R=0;R<p;R++){const g=Math.random()*e.height*.6+4,D=R*(v+m);t.fillStyle="white",t.fillRect(D,n-g/2,v,g)}};return W(s,e=>{e?(a("update:hasAudio",!0),oe(Q)):a("update:hasAudio",!1)}),W(r,e=>{e&&a("update:isRecording",e)}),ae(()=>{P()}),(e,t)=>(c(),l("div",{class:O(["",r.value?"relative":` ${z.class} `])},[ne(k("canvas",{ref_key:"canvasRef",ref:L,class:"w-full h-12 rounded-xl p-3 bg-bg-surface"},null,512),[[se,r.value]]),r.value?(c(),l("div",ce,j(Math.floor(w.value/60))+":"+j((w.value%60).toString().padStart(2,"0")),1)):y("",!0),s.value?y("",!0):(c(),l("button",{key:1,onClick:K,class:O([" text-sm overflow-hidden",r.value?"text-red-500 mt-1  absolute right-2 top-1":"text-text-primary"])},[r.value?(c(),l("div",ue,t[0]||(t[0]=[k("div",{class:"w-2 bg-white h-2 aspect-square"},null,-1)]))):(c(),l("div",de,t[1]||(t[1]=[k("i",{class:"text-white fa-solid fa-microphone font-base"},null,-1)])))],2)),A(G)&&s.value?(c(),l("p",ve,"Transcribing...")):y("",!0),A(J)&&s.value?(c(),l("p",fe,"Transcription failed.")):y("",!0),A(T)&&s.value?(c(),l("p",he,[t[2]||(t[2]=k("strong",null,"Transcirpt:",-1)),re(" "+j(A(T)),1)])):y("",!0)],2))}});export{ge as _};
