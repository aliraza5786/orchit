import{R as de,S as ue,T as Q,c as M,p as V,d as G,r as c,N as Ue,j as q,o as U,F as X,f as s,i as r,k as oe,t as B,w as E,h as H,W as lt,n as K,v as Ne,x as nt,e as Z,_ as R,ae as ye,B as z,g as W,ak as J,J as De,X as we,D as re,bd as he,P as it,be as Me,U as _e,y as Ce,an as rt,am as dt,bf as ut,M as We,Z as ct,$ as mt,ac as Ie,bg as pt,I as ke,O as ft,m as vt}from"./index-tfagm7Um.js";import{_ as gt}from"./DropMenu.vue_vue_type_script_setup_true_lang-D3eDHqZA.js";import{_ as ze}from"./ConfirmDeleteModal.vue_vue_type_script_setup_true_lang-DslWMS3t.js";import{u as bt,M as se,_ as _t,a as yt,b as wt,c as ge,P as be,d as xt}from"./useLocalWorkflowState-BjxCY8Ks.js";import{L as kt}from"./Loader-D46qLrei.js";import{_ as Ve}from"./BaseTextAreaField.vue_vue_type_script_setup_true_lang-ynPZsj6Q.js";import"./favicon-BAFXWHLW.js";const ht=[{id:"col-1",_id:"col-1",sheet_id:"sheet-1",workspace_id:"workspace-1",title:"Active Processes",order:0,created_at:"2024-01-15T10:00:00Z",processes:[]},{id:"col-3",_id:"col-3",sheet_id:"sheet-2",workspace_id:"workspace-1",title:"Development",order:0,created_at:"2024-01-20T14:30:00Z",processes:[]},{id:"col-4",_id:"col-4",sheet_id:"sheet-3",workspace_id:"workspace-1",title:"Design Queue",order:0,created_at:"2024-02-01T09:15:00Z",processes:[]}],Ct=[{id:"process-1",_id:"process-1",workspace_id:"workspace-1",title:"General Process",description:"Standard workflow for handling general tasks and approvals",column_id:"col-1",order:0,status_count:4,transition_count:5,created_at:"2024-01-15T10:00:00Z"},{id:"process-4",_id:"process-4",workspace_id:"workspace-1",title:"Feature Development",description:"End-to-end feature development workflow",column_id:"col-3",order:0,status_count:6,transition_count:8,created_at:"2024-01-20T14:30:00Z"},{id:"process-5",_id:"process-5",workspace_id:"workspace-1",title:"Bug Triage",description:"Process for triaging and prioritizing bugs",column_id:"col-3",order:1,status_count:4,transition_count:5,created_at:"2024-01-21T16:00:00Z"},{id:"process-6",_id:"process-6",workspace_id:"workspace-1",title:"Design Review",description:"Comprehensive design review and feedback process",column_id:"col-4",order:0,status_count:4,transition_count:6,created_at:"2024-02-01T09:15:00Z"}],Vt=[{id:"status-1",process_id:"process-1",status_name:"Create",category:"todo",status_color:"#6b7280",position_x:100,position_y:200,order:0,is_initial:!0,is_final:!1},{id:"status-2",process_id:"process-1",status_name:"To Do",category:"todo",status_color:"#6b7280",position_x:300,position_y:200,order:1,is_initial:!1,is_final:!1},{id:"status-3",process_id:"process-1",status_name:"In Progress",category:"inprogress",status_color:"#3b82f6",position_x:500,position_y:200,order:2,is_initial:!1,is_final:!1},{id:"status-4",process_id:"process-1",status_name:"Done",category:"done",status_color:"#10b981",position_x:700,position_y:200,order:3,is_initial:!1,is_final:!0}],St=[{id:"transition-1",process_id:"process-1",from_status_id:"status-1",to_status_id:"status-2",transition_label:"Start Task",rules:[]},{id:"transition-2",process_id:"process-1",from_status_id:"status-2",to_status_id:"status-3",transition_label:"Begin Work",rules:[]},{id:"transition-3",process_id:"process-1",from_status_id:"status-3",to_status_id:"status-4",transition_label:"Complete",rules:[]},{id:"transition-4",process_id:"process-1",from_status_id:"status-3",to_status_id:"status-2",transition_label:"Need Revision",rules:[]},{id:"transition-5",process_id:"process-1",from_status_id:"status-2",to_status_id:"status-4",transition_label:"Skip to Done",rules:[]}],Le=(b,m={})=>ue({queryKey:["process-sheets",b],queryFn:({signal:i})=>Q({url:`workspace/${b}/process-flow`,method:"GET",signal:i}),...m}),$t=(b,m={})=>ue({queryKey:["process-workflow",b],queryFn:({signal:i})=>Q({url:`workspace/${b}/process-flow/transitions`,method:"GET",signal:i}),...m}),Tt=(b,m,i={})=>ue({queryKey:["process-columns",b,m],queryFn:()=>{const p=V(m),o=ht.filter(d=>d.sheet_id===p);return Promise.resolve(o.map(d=>({...d,processes:Ct.filter(v=>v.column_id===d.id)})))},enabled:M(()=>!!V(m)),...i}),Pt=(b={})=>de({key:["create-process-column"]},{mutationFn:m=>Q({url:"/workspace/process-columns",method:"POST",data:m.payload}),...b}),Et=(b={})=>de({key:["delete-process-column"]},{mutationFn:m=>Q({url:`/workspace/process-columns/${m.id}`,method:"DELETE"}),...b}),At=(b={})=>de({key:["create-process"]},{mutationFn:m=>Q({url:"/workspace/processes",method:"POST",data:m.payload}),...b}),Ut=(b={})=>de({key:["delete-process"]},{mutationFn:m=>Q({url:`/workspace/processes/${m.id}`,method:"DELETE"}),...b}),Nt=(b,m={})=>ue({queryKey:["workflow-data",b],queryFn:()=>{const i=V(b),p=Vt.filter(d=>d.process_id===i),o=St.filter(d=>d.process_id===i);return Promise.resolve({statuses:p,transitions:o})},enabled:!!V(b),...m}),Dt=(b,m={})=>de({key:["create-transition"]},{mutationFn:i=>Q({url:`workspace/${b}/process-flow/transitions`,method:"POST",data:i.payload}),...m}),Mt=(b,m={})=>ue({queryKey:["process-status",b],queryFn:({signal:i})=>Q({url:`common/cardstatus-process?workspace_id=${b}`,method:"GET",signal:i}),...m}),Wt={class:"flex justify-between gap-2 items-start"},It={class:"flex items-start gap-3 flex-1"},zt={class:"flex-1 min-w-0"},Lt={class:"text-sm font-semibold text-text-primary leading-tight mb-1"},qt={key:0,class:"text-xs text-text-secondary line-clamp-2"},Ft=G({__name:"ProcessKanbanCard",props:{ticket:{},index:{}},emits:["click"],setup(b,{emit:m}){const i=b,p=m,o=c(!1),d=Ue();function v(){return[{label:"Open Workflow Builder",action:()=>{p("click")},icon:{prefix:"fa-regular",iconName:"fa-diagram-project"}},{label:"Delete Process",danger:!0,action:()=>{o.value=!0},icon:{prefix:"fa-regular",iconName:"fa-trash"}}]}const{mutate:_,isPending:w}=Ut({onSuccess:()=>{o.value=!1,d.invalidateQueries({queryKey:["process-columns"]})}}),k=()=>{_({id:i.ticket._id})};return(S,f)=>{var D,N;return U(),q(X,null,[s("div",{onClick:f[1]||(f[1]=h=>S.$emit("click")),class:"bg-bg-card rounded-lg p-4 shadow-sm cursor-pointer hover:shadow-md transition-all duration-200 border border-border hover:border-accent"},[s("div",Wt,[s("div",It,[f[5]||(f[5]=s("div",{class:"w-10 h-10 bg-accent/20 flex justify-center items-center rounded-lg"},[s("i",{class:"fa-solid fa-diagram-project text-accent"})],-1)),s("div",zt,[s("h3",Lt,B(((D=S.ticket)==null?void 0:D.title)??`Process ${S.index+1}`),1),(N=S.ticket)!=null&&N.description?(U(),q("p",qt,B(S.ticket.description),1)):oe("",!0)])]),r(gt,{onClick:f[0]||(f[0]=H(()=>{},["stop"])),items:v()},{trigger:E(()=>f[6]||(f[6]=[s("i",{class:"cursor-pointer fa-solid fa-ellipsis text-text-secondary hover:text-text-primary"},null,-1)])),_:1},8,["items"])])]),r(ze,{onClick:f[2]||(f[2]=H(()=>{},["stop"])),modelValue:o.value,"onUpdate:modelValue":f[3]||(f[3]=h=>o.value=h),title:"Delete Process",itemLabel:"process",itemName:S.ticket.title,requireMatchText:S.ticket.title,confirmText:"Delete Process",cancelText:"Cancel",size:"md",loading:V(w),onConfirm:k,onCancel:f[4]||(f[4]=()=>{o.value=!1})},null,8,["modelValue","itemName","requireMatchText","loading"])],64)}}}),Bt={class:"workflow-wrap"},jt={class:"absolute bottom-20 right-2 flex flex-col gap-2 z-10 bg-accent p-1 rounded-lg shadow-md border border-accent"},Ht={class:"relative min-w-[60px] px-1.5 py-0.5 rounded-md text-xs"},Kt={class:"flex justify-between items-center gap-1.5"},Ot={class:"truncate"},Zt={class:"flex items-center gap-1.5"},Rt=["onClick"],Qt=["onClick"],Gt={class:"modal border border-border !bg-bg-body text-text-primary"},Yt={class:"modal-actions mt-4"},Jt={class:"modal border border-border !bg-bg-body text-text-primary"},Xt={class:"modal-actions mt-4"},es=G({__name:"WorkflowCanvas",emits:["edit:node"],setup(b,{expose:m,emit:i}){const p=c(!1),o=c(""),d=c(null),v=c([]),_=c([]),{setNodes:w,updateNode:k,addEdges:S,setEdges:f,removeEdges:D,onNodesInitialized:N,fitView:h,updateNodeInternals:u,addNodes:C,project:j,getNodes:T,getEdges:x,zoomIn:g,zoomOut:y}=bt(),{workspaceId:$}=lt(),{refetch:O}=Le($.value),{data:ee,isSuccess:ae}=Mt($.value),{data:Y,isSuccess:le,isPending:l,isFetching:a,refetch:I}=$t($.value);function ce(t){return{id:t.id,type:t.type??"default",position:t.position,data:t.data,style:t.style}}function me(t){const e=(t??"arrow").toLowerCase();return e==="arrow"?se.Arrow:e==="arrowclosed"?se.ArrowClosed:se.Arrow}function L(t){var A,P,ie,F,ve;const e=t.markerEnd||t.marker_end,n=t.style;return{id:t.id||((A=t.flow_metadata)==null?void 0:A.transition_id),type:t.type??"step",source:t.source??((ie=(P=t.flow_metadata)==null?void 0:P.source_node)==null?void 0:ie.id),target:t.target??((ve=(F=t.flow_metadata)==null?void 0:F.target_node)==null?void 0:ve.id),sourceHandle:t.sourceHandle??t.source_handle,targetHandle:t.targetHandle??t.target_handle,label:t.label,data:t.data,animated:t.animated??!1,style:n?{...n,strokeWidth:Number(n.strokeWidth??2)}:void 0,markerEnd:e?{type:me(e.type),color:e.color,width:Number(e.width??18),height:Number(e.height??18)}:void 0}}K([()=>ae.value,()=>le.value,a],async([t,e])=>{var n,A;if(t&&e&&ee.value&&!((n=Y.value)!=null&&n.raw_transitions.nodes)){const P=ee.value.map((F,ve)=>({id:String(F._id),type:F.type??"default",position:{x:300*ve,y:34},data:{label:F.value,status:"To Do"}}));await J(),w(P),await J(),v.value=P,await J();const ie=[];for(let F=0;F<P.length-1;F++)ie.push({id:`edge-${P[F].id}-${P[F+1].id}`,source:P[F].id,target:P[F+1].id,type:"step",label:"Auto Transition",animated:!1,style:{stroke:"#1152de",strokeWidth:2},markerEnd:{type:se.Arrow,color:"#1152de",width:18,height:18},sourceHandle:"out-right",targetHandle:"in-left"});(A=Y.value)!=null&&A.raw_transitions.nodes||f(ie),await J()}},{immediate:!0}),K(Y,async t=>{if(!(t!=null&&t.raw_transitions))return;const e=t.raw_transitions,n=Array.isArray(e.nodes)?e.nodes.map(ce):[],A=Array.isArray(e.edges)?e.edges.map(L):[];await J(),w(n),N(async()=>{n.forEach(P=>u(P.id)),f(A),h({padding:.5}),await J()})},{immediate:!0});function pe(t){ne.value=t,te.value="",fe.value=!0}function xe(){var P;if(!ne.value)return;const t=ne.value,e=te.value.trim()||"Transition",n=`${t.source}-${t.target}-${((P=crypto.randomUUID)==null?void 0:P.call(crypto))??Math.random()}`,A={...t,id:n,type:"step",label:e,data:{name:e},style:{stroke:"#1152de",strokeWidth:2},markerEnd:{type:se.Arrow,color:"#1152de",width:18,height:18},sourceHandle:t.sourceHandle,targetHandle:t.targetHandle};S(A),fe.value=!1,ne.value=null,te.value=""}function Se(){fe.value=!1,ne.value=null,te.value=""}const{mutate:qe,isPending:$e}=Dt($.value,{onSuccess:()=>{I(),O()}}),Fe={type:"default",animated:!1,style:{strokeWidth:2},markerEnd:{type:se.Arrow,color:"#3b82f6",width:18,height:18},labelBgPadding:[6,2],labelBgBorderRadius:6,updatable:!0},Be=c(!1),je=c(""),fe=c(!1),te=c(""),ne=c(null),He=i;function Ke(){je.value="",Be.value=!0}function Oe(t,e){const n=T.value.find(A=>A.id===t);console.log(n,">>>>"),n&&He("edit:node",{id:t,...n.data,status_color:e.status||"#6b7280"})}function Ze(t,e){e&&k(t,n=>({...n,data:{...n.data,label:e.name,status:e.category},style:{border:"2px solid #64748b",borderRadius:"8px",background:e.status_color}})),J()}async function Re(t){const n=(()=>{var P;return((P=crypto.randomUUID)==null?void 0:P.call(crypto))??`n-${Date.now()}-${Math.random()}`})(),A=j({x:t.position_x,y:t.position_y});C({id:n,position:A,data:{label:t.name,status:t.status_name},style:{border:"2px solid #64748b",borderRadius:"8px",background:t.status_color}})}m({openCreateNodeModal:Ke,handleAddNode:Re,saveWorkflow:Te,isSaving:$e,handleConfirmEdit:Ze});function Qe(t){if(!t)return;const e=String(t).toLowerCase();return e.includes("arrowclosed")?"arrowclosed":e.includes("arrow")?"arrow":e.includes("circle")?"circle":e.includes("square")?"square":e.includes("diamond")?"diamond":e.includes("dot")?"dot":"arrow"}function Ge(t){return{id:t.id,type:t.type??"default",position:t.position,data:t.data,style:t.style}}function Ye(t){const e=t.markerEnd,n=e?(()=>{const A=typeof e=="string"?e:e.type;return{type:Qe(A),color:typeof e=="string"?void 0:e.color,width:typeof e=="string"?void 0:Number(e.width??18),height:typeof e=="string"?void 0:Number(e.height??18)}})():void 0;return{id:t.id,type:t.type??"step",source:t.source,target:t.target,source_handle:t.sourceHandle,target_handle:t.targetHandle,label:t.label,data:t.data,style:t.style?{...t.style,strokeWidth:Number(t.style.strokeWidth??2)}:void 0,marker_end:n,animated:!!t.animated}}function Je(){const t=T.value,e=x.value;return{workspace_id:$.value,flow_diagram:{nodes:t.map(Ge),edges:e.map(Ye)}}}function Te(){const t=Je();console.log(" >>> saving workspace",t),qe({payload:t})}window.addEventListener("beforeunload",()=>{if(!$e.value)try{Te()}catch{}});function Xe(t){var e;console.log(t,"edge"),d.value=t.id,o.value=String(t.label??((e=t.data)==null?void 0:e.name)??""),p.value=!0}function Pe(){if(!d.value)return;const t=o.value.trim();f(e=>e.map(n=>{var A;return n.id===d.value?{...n,label:t||n.label,data:{...n.data??{},name:t||((A=n.data)==null?void 0:A.name)}}:n})),p.value=!1,d.value=null,o.value=""}function et(){d.value&&(D([d.value]),p.value=!1,d.value=null,o.value="")}function tt(t){w(e=>e.filter(n=>n.id!==t)),f(e=>e.filter(n=>n.source!==t&&n.target!==t)),d.value=null}function st(t){window.confirm("Are you sure you want to delete this status? All transitions will also be removed.")&&tt(t)}function ot(t){const{edge:e,connection:n}=t;!e||!n||f(A=>A.map(P=>P.id===e.id?{...P,source:n.source,target:n.target,sourceHandle:n.sourceHandle,targetHandle:n.targetHandle}:P))}function Ee(){p.value=!1,d.value=null,o.value=""}function at({event:t,edge:e}){console.log(">>> click",e),Xe(e),t.stopPropagation()}Ne(()=>{window.addEventListener("workflow:zoom",Ae)}),nt(()=>{window.removeEventListener("workflow:zoom",Ae)});function Ae(t){const e=t.detail;e&&(e.action==="in"&&g(),e.action==="out"&&y(),e.action==="reset"&&h({padding:.2}))}return(t,e)=>(U(),q(X,null,[s("div",Bt,[V(l)||V(a)?(U(),Z(kt,{key:0})):(U(),Z(V(_t),{key:1,nodes:v.value,"onUpdate:nodes":e[3]||(e[3]=n=>v.value=n),edges:_.value,"onUpdate:edges":e[4]||(e[4]=n=>_.value=n),"default-edge-options":Fe,"nodes-draggable":!0,"nodes-connectable":!0,"elements-selectable":!0,"min-zoom":.01,"max-zoom":100,"fit-view-on-init":"",onConnect:pe,onEdgeClick:at,onEdgeUpdate:ot,"edge-updater-radius":20},{"node-default":E(({id:n,data:A})=>[s("div",Ht,[s("div",Kt,[s("span",Ot,B(A.label),1),s("div",Zt,[s("i",{class:"fa-solid fa-edit cursor-pointer text-xs opacity-70 hover:opacity-100",onClick:H(P=>Oe(n,A),["stop"])},null,8,Rt),s("i",{class:"fa-solid fa-trash cursor-pointer text-red-500/80 hover:text-red-500 text-xs",onClick:H(P=>st(n),["stop"])},null,8,Qt)])]),r(V(ge),{id:"in-top",type:"target",position:V(be).Top},null,8,["position"]),r(V(ge),{id:"out-right",type:"source",position:V(be).Right},null,8,["position"]),r(V(ge),{id:"out-bottom",type:"source",position:V(be).Bottom},null,8,["position"]),r(V(ge),{id:"in-left",type:"target",position:V(be).Left},null,8,["position"])])]),default:E(()=>[r(V(yt)),r(V(wt),{"show-zoom":!1,"show-fit-view":!1,"show-interactive":!1,position:"top-right"}),s("div",jt,[s("button",{onClick:e[0]||(e[0]=n=>V(g)()),class:"w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded text-white hover:text-gray-500 cursor-pointer",title:"Zoom In"},e[7]||(e[7]=[s("i",{class:"fa-solid fa-plus"},null,-1)])),s("button",{onClick:e[1]||(e[1]=n=>V(y)()),class:"w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded text-white hover:text-gray-500 cursor-pointer",title:"Zoom Out"},e[8]||(e[8]=[s("i",{class:"fa-solid fa-minus"},null,-1)])),s("button",{onClick:e[2]||(e[2]=n=>V(h)({padding:.2})),class:"w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded text-white hover:text-gray-500 cursor-pointer",title:"Fit View"},e[9]||(e[9]=[s("i",{class:"fa-solid fa-compress"},null,-1)]))])]),_:1},8,["nodes","edges"])),fe.value?(U(),q("div",{key:2,class:"modal-backdrop",onClick:H(Se,["self"])},[s("div",Gt,[e[12]||(e[12]=s("h3",null,"Name this transition",-1)),r(R,{modelValue:te.value,"onUpdate:modelValue":e[5]||(e[5]=n=>te.value=n),placeholder:"e.g., Start work, Complete",onKeyup:ye(xe,["enter"]),autofocus:""},null,8,["modelValue"]),s("div",Yt,[r(z,{size:"sm",onClick:xe},{default:E(()=>e[10]||(e[10]=[W("Add Transition")])),_:1,__:[10]}),r(z,{variant:"secondary",size:"sm",onClick:Se},{default:E(()=>e[11]||(e[11]=[W("Cancel")])),_:1,__:[11]})])])])):oe("",!0)]),p.value?(U(),q("div",{key:0,class:"modal-backdrop",onClick:H(Ee,["self"])},[s("div",Jt,[e[16]||(e[16]=s("h3",null,"Edit transition",-1)),r(R,{modelValue:o.value,"onUpdate:modelValue":e[6]||(e[6]=n=>o.value=n),placeholder:"Transition name",onKeyup:ye(Pe,["enter"]),autofocus:""},null,8,["modelValue"]),s("div",Xt,[r(z,{size:"sm",onClick:Pe},{default:E(()=>e[13]||(e[13]=[W("Save")])),_:1,__:[13]}),r(z,{variant:"secondary",size:"sm",onClick:Ee},{default:E(()=>e[14]||(e[14]=[W("Cancel")])),_:1,__:[14]}),r(z,{size:"sm",variant:"danger",onClick:et},{default:E(()=>e[15]||(e[15]=[W(" Delete ")])),_:1,__:[15]})])])])):oe("",!0)],64))}}),ts=De(es,[["__scopeId","data-v-aa8c90fc"]]),ss={class:"p-6"},os={class:"text-lg font-semibold text-text-primary mb-4"},as={class:"space-y-4"},ls={class:"flex items-center gap-3"},ns={class:"mt-6 flex justify-end gap-2"},is=G({__name:"AddStatusModal",props:{modelValue:{type:Boolean},processId:{},editingStatus:{}},emits:["update:modelValue","status:added","edit:node"],setup(b,{emit:m}){const i=b,p=m,o=M({get:()=>i.modelValue,set:T=>p("update:modelValue",T)}),d=Me("workflowState"),v=c(""),_=c("todo"),w=c("#6b7280"),k=c(!1),S=c(!1),f=c(!1),D={todo:"#6b7280",inprogress:"#3b82f6",done:"#10b981"},N=M(()=>!!i.editingStatus);K(i,()=>{var T,x,g,y,$,O;v.value=((T=i.editingStatus)==null?void 0:T.label)||"",_.value=((x=i.editingStatus)==null?void 0:x.status)||"todo",w.value=((g=i.editingStatus)==null?void 0:g.status_color)||((y=i.editingStatus)==null?void 0:y.status)||"#6b7280",k.value=(($=i.editingStatus)==null?void 0:$.is_initial)||!1,S.value=((O=i.editingStatus)==null?void 0:O.is_final)||!1});function h(){w.value=D[_.value]}function u(){}function C(){v.value="",o.value=!1}function j(){if(v.value.trim()){f.value=!0;try{if(N.value){console.log("editing mode on ");const T={...i.editingStatus,name:v.value.trim(),category:_.value,status_color:w.value,is_initial:k.value,is_final:S.value,status_name:v.value.trim()};d.updateStatus(i.editingStatus.id,T),p("edit:node",i.editingStatus.id,T)}else{console.log("editing mode close ");const T={process_id:i.processId,name:v.value.trim(),category:_.value,status_color:w.value,is_initial:k.value,is_final:S.value,status_name:_.value.trim(),position_x:Math.random()*400+100,position_y:Math.random()*300+100,order:d.localStatuses.value.length};d.addStatus(T),p("status:added",T)}C()}catch{_e.error(N.value?"Failed to update status":"Failed to add status")}finally{f.value=!1}}}return(T,x)=>(U(),Z(we,{modelValue:o.value,"onUpdate:modelValue":x[4]||(x[4]=g=>o.value=g),size:"md"},{default:E(()=>[s("div",ss,[s("h3",os,B(N.value?"Edit Status":"Add Status"),1),s("div",as,[s("div",null,[x[5]||(x[5]=s("label",{class:"text-sm font-medium text-text-primary mb-1.5 block"},"Status Name",-1)),r(R,{modelValue:v.value,"onUpdate:modelValue":x[0]||(x[0]=g=>v.value=g),placeholder:"e.g., To Do, In Progress, Done",autofocus:!0},null,8,["modelValue"])]),s("div",null,[x[7]||(x[7]=s("label",{class:"text-sm font-medium text-text-primary mb-1.5 block"},"Category",-1)),re(s("select",{"onUpdate:modelValue":x[1]||(x[1]=g=>_.value=g),onChange:h,class:"w-full px-3 py-2 text-sm bg-bg-surface border border-border rounded-md text-text-primary focus:outline-none focus:ring-1 focus:ring-accent"},x[6]||(x[6]=[s("option",{value:"todo"},"To Do",-1),s("option",{value:"inprogress"},"In Progress",-1),s("option",{value:"done"},"Done",-1)]),544),[[he,_.value]]),x[8]||(x[8]=s("p",{class:"text-xs text-text-secondary mt-1"},"Category cannot be changed after creation",-1))]),s("div",null,[x[9]||(x[9]=s("label",{class:"text-sm font-medium text-text-primary mb-1.5 block"},"Status Color",-1)),s("div",ls,[re(s("input",{type:"color","onUpdate:modelValue":x[2]||(x[2]=g=>w.value=g),onInput:u,class:"h-10 w-20 rounded border border-border cursor-pointer"},null,544),[[it,w.value]]),r(R,{modelValue:w.value,"onUpdate:modelValue":x[3]||(x[3]=g=>w.value=g),placeholder:"#3b82f6",class:"flex-1"},null,8,["modelValue"])])])]),s("div",ns,[r(z,{onClick:C,variant:"secondary"},{default:E(()=>x[10]||(x[10]=[W("Cancel")])),_:1,__:[10]}),r(z,{onClick:j,disabled:!v.value.trim()||f.value},{default:E(()=>[W(B(f.value?N.value?"Updating...":"Adding...":N.value?"Update Status":"Add Status"),1)]),_:1},8,["disabled"])])])]),_:1},8,["modelValue"]))}}),rs={class:"p-6"},ds={class:"space-y-4"},us=["value"],cs=["value"],ms={class:"mt-6 flex justify-end gap-2"},ps=G({__name:"AddTransitionModal",props:{modelValue:{type:Boolean},processId:{},statuses:{}},emits:["update:modelValue","transition:added"],setup(b,{emit:m}){const i=b,p=m,o=M({get:()=>i.modelValue,set:h=>p("update:modelValue",h)}),d=Me("workflowState"),v=c(""),_=c(""),w=c(""),k=c(""),S=c(!1),f=M(()=>v.value&&_.value&&v.value!==_.value);K(()=>i.modelValue,h=>{h&&(v.value="",_.value="",w.value="",k.value="")});function D(){o.value=!1}function N(){if(f.value){if(d.hasTransition(v.value,_.value)){_e.error("A transition already exists between these statuses");return}S.value=!0;try{const h={process_id:i.processId,from_status_id:v.value,to_status_id:_.value,transition_label:w.value.trim(),rules:k.value?[{description:k.value}]:[]};d.addTransition(h),_e.success("Transition added successfully"),p("transition:added"),D()}catch{_e.error("Failed to add transition")}finally{S.value=!1}}}return(h,u)=>(U(),Z(we,{modelValue:o.value,"onUpdate:modelValue":u[4]||(u[4]=C=>o.value=C),size:"md"},{default:E(()=>[s("div",rs,[u[12]||(u[12]=s("h3",{class:"text-lg font-semibold text-text-primary mb-4"},"Add Transition",-1)),s("div",ds,[s("div",null,[u[6]||(u[6]=s("label",{class:"text-sm font-medium text-text-primary mb-1.5 block"},"From Status",-1)),re(s("select",{"onUpdate:modelValue":u[0]||(u[0]=C=>v.value=C),class:"w-full px-3 py-2 text-sm bg-bg-surface border border-border rounded-md text-text-primary focus:outline-none focus:ring-1 focus:ring-accent"},[u[5]||(u[5]=s("option",{value:""},"Select source status",-1)),(U(!0),q(X,null,Ce(h.statuses,C=>(U(),q("option",{key:C.id,value:C.id},B(C.status_name),9,us))),128))],512),[[he,v.value]])]),s("div",null,[u[8]||(u[8]=s("label",{class:"text-sm font-medium text-text-primary mb-1.5 block"},"To Status",-1)),re(s("select",{"onUpdate:modelValue":u[1]||(u[1]=C=>_.value=C),class:"w-full px-3 py-2 text-sm bg-bg-surface border border-border rounded-md text-text-primary focus:outline-none focus:ring-1 focus:ring-accent"},[u[7]||(u[7]=s("option",{value:""},"Select destination status",-1)),(U(!0),q(X,null,Ce(h.statuses,C=>(U(),q("option",{key:C.id,value:C.id},B(C.status_name),9,cs))),128))],512),[[he,_.value]])]),s("div",null,[u[9]||(u[9]=s("label",{class:"text-sm font-medium text-text-primary mb-1.5 block"},"Transition Label (Optional)",-1)),r(R,{modelValue:w.value,"onUpdate:modelValue":u[2]||(u[2]=C=>w.value=C),placeholder:"e.g., Start work, Complete, Approve"},null,8,["modelValue"])]),s("div",null,[u[10]||(u[10]=s("label",{class:"text-sm font-medium text-text-primary mb-1.5 block"},"Rules (Optional)",-1)),r(Ve,{modelValue:k.value,"onUpdate:modelValue":u[3]||(u[3]=C=>k.value=C),placeholder:"Add any rules or conditions for this transition"},null,8,["modelValue"])])]),s("div",ms,[r(z,{onClick:D,variant:"secondary"},{default:E(()=>u[11]||(u[11]=[W("Cancel")])),_:1,__:[11]}),r(z,{onClick:N,disabled:!f.value||S.value},{default:E(()=>[W(B(S.value?"Adding...":"Add Transition"),1)]),_:1},8,["disabled"])])])]),_:1},8,["modelValue"]))}}),fs={class:"relative flex h-full w-full flex-col bg-bg-body",role:"dialog","aria-modal":"true",tabindex:"0"},vs={class:"border-b border-border px-[20px] sm:px-6 py-4 overflow-x-auto"},gs={class:"flex items-center justify-between max-w-content gap-3"},bs={class:"flex items-center gap-4"},_s={class:"flex items-center gap-2 text-lg sm:text-xl font-semibold text-text-primary text-nowrap"},ys={class:"flex cursor-pointer items-center gap-2 text-sm text-text-secondary text-nowrap"},ws={class:"flex items-center gap-3"},xs={class:"relative flex-1 overflow-hidden"},ks={key:0,class:"flex items-center justify-center h-full bg-bg-surface"},hs=G({__name:"WorkflowBuilderModal",props:{modelValue:{type:Boolean},process:{}},emits:["update:modelValue","close"],setup(b,{emit:m}){const i=b,p=m,o=c(null),d=c(!0),v=c(!1),_=c(!1),w=M(()=>i.modelValue),k=M(()=>{var l,a;return((l=i.process)==null?void 0:l._id)??((a=i.process)==null?void 0:a.id)??""}),S=M(()=>{var l;return((l=i.process)==null?void 0:l.title)??"Process"}),{data:f,refetch:D,isLoading:N}=Nt(k),h=xt();ut("workflowState",h);const u=c(null),C=M(()=>h.localStatuses.value);K(w,l=>{l&&k.value&&D()}),K(()=>f.value,l=>{l&&w.value&&h.initialize(l.statuses,l.transitions)},{immediate:!0});const j=M(()=>{var l;return!!((l=o.value)!=null&&l.isSaving)}),T=M(()=>{if(j.value)return"Updating...";const l=h.changeCount.value||0;return l>0?`Update workflow (${l})`:"Update workflow"});function x(){h.hasChanges.value&&!window.confirm("You have unsaved changes. Are you sure you want to close?")||(p("update:modelValue",!1),p("close"))}function g(){u.value="",v.value=!0}function y(){_.value=!0}function $(){D()}function O(){var l;(l=o.value)==null||l.saveWorkflow()}function ee(l){var a,I;v.value=!1,(I=(a=o.value)==null?void 0:a.handleAddNode)==null||I.call(a,l),u.value=null}function ae(){_.value=!1}function Y(l){u.value=l,v.value=!0}const le=(l,a)=>{var I;(I=o.value)==null||I.handleConfirmEdit(l,a)};return(l,a)=>(U(),q(X,null,[r(rt,{name:"fade"},{default:E(()=>[w.value?(U(),q("div",{key:0,class:"fixed inset-0 z-50 bottom-[60px] sm:bottom-0 flex items-center justify-center bg-black/80 backdrop-blur-sm",onKeydown:ye(x,["esc"])},[s("div",fs,[s("div",vs,[s("div",gs,[s("div",bs,[s("h2",_s,[a[3]||(a[3]=s("i",{class:"fa-solid fa-diagram-project text-accent","aria-hidden":"true"},null,-1)),W(" Workflow for "+B(S.value),1)]),s("label",ys,[re(s("input",{type:"checkbox","onUpdate:modelValue":a[0]||(a[0]=I=>d.value=I),class:"rounded"},null,512),[[dt,d.value]]),a[4]||(a[4]=s("span",null,"Show transition labels",-1))])]),s("div",ws,[r(z,{variant:"secondary",size:"sm",onClick:g},{default:E(()=>a[5]||(a[5]=[s("i",{class:"fa-solid fa-plus mr-2","aria-hidden":"true"},null,-1),W(" Add Status ")])),_:1,__:[5]}),r(z,{variant:"primary",size:"sm",disabled:j.value,onClick:O},{default:E(()=>[W(B(T.value),1)]),_:1},8,["disabled"]),s("button",{class:"text-xl text-text-secondary hover:text-text-primary",onClick:x,"aria-label":"Close"},a[6]||(a[6]=[s("i",{class:"fa-solid fa-times","aria-hidden":"true"},null,-1)]))])])]),s("div",xs,[V(N)?(U(),q("div",ks,a[7]||(a[7]=[s("div",{class:"flex flex-col items-center gap-4"},[s("div",{class:"animate-spin rounded-full h-12 w-12 border-4 border-accent border-t-transparent"}),s("p",{class:"text-sm text-text-secondary"},"Loading workflow...")],-1)]))):k.value?(U(),Z(ts,{key:1,ref_key:"Canvas",ref:o,"process-id":k.value,"show-transition-labels":d.value,"onUpdate:workflow":$,"onAdd:status":g,"onAdd:transition":y,"onEdit:node":Y},null,8,["process-id","show-transition-labels"])):oe("",!0)])])],32)):oe("",!0)]),_:1}),r(is,{modelValue:v.value,"onUpdate:modelValue":a[1]||(a[1]=I=>v.value=I),"process-id":k.value,"editing-status":u.value,"onStatus:added":ee,"onEdit:node":le},null,8,["modelValue","process-id","editing-status"]),r(ps,{modelValue:_.value,"onUpdate:modelValue":a[2]||(a[2]=I=>_.value=I),"process-id":k.value,statuses:C.value,"onTransition:added":ae},null,8,["modelValue","process-id","statuses"])],64))}}),Cs=De(hs,[["__scopeId","data-v-b69e9be4"]]),Vs={class:"px-6"},Ss={class:"flex items-center gap-3 pt-4"},$s=G({__name:"CreateProcessSheetModal",props:{modelValue:{type:Boolean}},emits:["update:modelValue","created"],setup(b,{emit:m}){const i=m,p=c(""),o=c(""),d=c(!1),v=async()=>{p.value.trim()&&(d.value=!0,setTimeout(()=>{const w={_id:`sheet-${Date.now()}`,title:p.value,description:o.value,icon:{prefix:"fa-solid",iconName:"fa-diagram-project"},workspace_id:"workspace-1",created_at:new Date().toISOString()};i("created",w),p.value="",o.value="",d.value=!1,_()},500))},_=()=>{i("update:modelValue",!1),p.value="",o.value=""};return(w,k)=>(U(),Z(we,{modelValue:w.modelValue,"onUpdate:modelValue":_,size:"md"},{default:E(()=>[s("div",Vs,[k[3]||(k[3]=s("h2",{class:"text-xl font-semibold text-text-primary mb-4"},"Create Process Sheet",-1)),s("form",{onSubmit:H(v,["prevent"]),class:"space-y-4"},[r(R,{modelValue:p.value,"onUpdate:modelValue":k[0]||(k[0]=S=>p.value=S),label:"Sheet Title",placeholder:"e.g., General Process",required:"",autofocus:!0},null,8,["modelValue"]),r(Ve,{modelValue:o.value,"onUpdate:modelValue":k[1]||(k[1]=S=>o.value=S),label:"Description",placeholder:"Describe this process sheet...",rows:"3"},null,8,["modelValue"]),s("div",Ss,[r(z,{type:"submit",variant:"primary",size:"md",disabled:!p.value.trim()||d.value},{default:E(()=>[W(B(d.value?"Creating...":"Create Sheet"),1)]),_:1},8,["disabled"]),r(z,{type:"button",variant:"secondary",size:"md",onClick:_},{default:E(()=>k[2]||(k[2]=[W(" Cancel ")])),_:1,__:[2]})])],32)])]),_:1},8,["modelValue"]))}}),Ts={class:"px-6 relative"},Ps={class:"flex items-center gap-3 pt-4 pb-2"},Es=G({__name:"AddProcessModal",props:{modelValue:{type:Boolean}},emits:["update:modelValue","created"],setup(b,{emit:m}){const i=m,{workspaceId:p}=We(),o=c({name:"",description:"",module_id:null,sheet_id:null,process_type_id:null}),{data:d,isLoading:v}=ct(p),_=M(()=>{var g;return(((g=d.value)==null?void 0:g.modules)||[]).map(y=>{var $;return{_id:y._id,title:(($=y.variables)==null?void 0:$["module-title"])||y.module_id}})}),{data:w,isLoading:k}=mt({workspace_id:p,workspace_module_id:M(()=>o.value.module_id)},{enabled:M(()=>!!o.value.module_id)});Ie(()=>{console.log(w.value,"these are all workspace data")});const S=M(()=>(w.value||[]).map(g=>{var y;return{_id:g._id,title:(y=g.variables)==null?void 0:y["sheet-title"]}})),{data:f,isLoading:D}=pt(p,M(()=>o.value.module_id),c("card-type"),{enabled:M(()=>!!o.value.module_id&&!!o.value.sheet_id)}),N=M(()=>{var g;return(((g=f.value)==null?void 0:g.values)||[]).map(y=>({_id:y._id,title:y.value||y.title}))});K(()=>o.value.module_id,()=>{o.value.sheet_id=null,o.value.process_type_id=null}),K(()=>o.value.sheet_id,()=>{o.value.process_type_id=null});const h=M(()=>o.value.name.trim().length>0&&o.value.module_id&&o.value.sheet_id&&o.value.process_type_id),{mutate:u,isPending:C}=At({onSuccess:g=>{i("created",g),T()}}),j=()=>{if(!h.value)return;const g={workspace_id:p.value,title:o.value.name,description:o.value.description,workspace_module_id:o.value.module_id,sheet_id:o.value.sheet_id,process_type_id:o.value.process_type_id};u({payload:g})},T=()=>{i("update:modelValue",!1),x()},x=()=>{o.value={name:"",description:"",module_id:null,sheet_id:null,process_type_id:null}};return(g,y)=>(U(),Z(we,{modelValue:g.modelValue,"onUpdate:modelValue":T,size:"md"},{default:E(()=>[s("div",Ts,[y[6]||(y[6]=s("h2",{class:"text-xl font-semibold text-text-primary mb-6"},"Add New Process",-1)),s("form",{onSubmit:H(j,["prevent"]),class:"space-y-5"},[r(R,{modelValue:o.value.name,"onUpdate:modelValue":y[0]||(y[0]=$=>o.value.name=$),label:"Process Name",placeholder:"Enter process name",required:"",autofocus:!0},null,8,["modelValue"]),r(Ve,{modelValue:o.value.description,"onUpdate:modelValue":y[1]||(y[1]=$=>o.value.description=$),label:"Process Description",placeholder:"Enter process description",rows:"3"},null,8,["modelValue"]),r(ke,{modelValue:o.value.module_id,"onUpdate:modelValue":y[2]||(y[2]=$=>o.value.module_id=$),options:_.value,label:"Select Module",placeholder:"Select a module",required:"",loading:V(v)},null,8,["modelValue","options","loading"]),r(ke,{modelValue:o.value.sheet_id,"onUpdate:modelValue":y[3]||(y[3]=$=>o.value.sheet_id=$),options:S.value,label:"Select Sheet",placeholder:"Select a sheet",required:"",disabled:!o.value.module_id,loading:V(k)},null,8,["modelValue","options","disabled","loading"]),r(ke,{modelValue:o.value.process_type_id,"onUpdate:modelValue":y[4]||(y[4]=$=>o.value.process_type_id=$),options:N.value,label:"Select Process Type",placeholder:"Select process type",required:"",disabled:!o.value.sheet_id,loading:V(D)},null,8,["modelValue","options","disabled","loading"]),s("div",Ps,[r(z,{type:"submit",variant:"primary",size:"md",disabled:!h.value||V(C),class:"flex-1"},{default:E(()=>[W(B(V(C)?"Creating...":"Create Process"),1)]),_:1},8,["disabled"]),r(z,{type:"button",variant:"secondary",size:"md",onClick:T,class:"flex-1"},{default:E(()=>y[5]||(y[5]=[W(" Cancel ")])),_:1,__:[5]})])],32)])]),_:1},8,["modelValue"]))}}),As={class:"flex-auto flex-grow h-full bg-bg-card rounded-lg border border-border overflow-x-auto flex-col flex items-start"},Us={class:"max-w-82 p-4 bg-bg-body rounded-md m-4"},Ns={class:"max-w-82 p-4 bg-bg-body rounded-md mx-4"},Ds={key:0,class:"bg-bg-body rounded-lg p-4"},Ms={class:"flex items-center mt-3 gap-3"},js=G({__name:"Process",setup(b){const m=c(!1),i=vt(),p=c(!1),o=c(),{workspaceId:d}=We(),{data:v}=Le(d.value),_=c("sheet-1");K(v,l=>{var a;l&&l.length>0&&!_.value&&(_.value=(a=l[0])==null?void 0:a._id)});const w=c(!1),{mutate:k,isPending:S}=Pt({onSuccess:l=>{f.value=[...f.value||[],{...l,cards:[]}],C.value="",u.value=!1}}),f=c([]),{data:D}=Tt(d.value,_);Ie(()=>{console.log(D.value,"this is the list ")}),K(D,l=>{l&&(f.value=l.map(a=>({...a,_id:a.id,cards:a.processes||[]})))}),Ne(()=>{D.value&&(f.value=D.value.map(l=>({...l,_id:l.id,cards:l.processes||[]})))});const N=c(null),h=c(!1),u=c(!1),C=c("");function j(){u.value=!u.value}function T(){const l=C.value.trim();l&&x(l)}const x=l=>{const a={workspace_id:d.value,sheet_id:_.value,title:l,order:f.value.length};k({payload:a})},g=Ue(),{mutate:y,isPending:$}=Et({onSuccess:()=>{p.value=!1,g.invalidateQueries({queryKey:["process-columns"]})}}),O=()=>{var l;y({id:(l=o.value)==null?void 0:l.columnId})},ee=l=>{N.value=l,h.value=!0},ae=()=>{h.value=!1,N.value=null},Y=()=>{w.value=!1,g.invalidateQueries({queryKey:["process-sheets"]})},le=()=>{m.value=!1,g.invalidateQueries({queryKey:["process-columns"]})};return(l,a)=>{var I,ce,me;return U(),q(X,null,[s("div",As,[s("div",Us,[(U(!0),q(X,null,Ce((I=f.value[0])==null?void 0:I.cards,(L,pe)=>(U(),Z(Ft,{onClick:xe=>ee(L),key:pe,ticket:L,index:pe},null,8,["onClick","ticket","index"]))),128))]),s("div",Ns,[s("div",{onClick:a[0]||(a[0]=L=>V(i).push(`/workspace/custom-process/${V(d)}`)),class:"bg-bg-card rounded-lg p-4 shadow-sm cursor-pointer hover:shadow-md transition-all duration-200 border border-border hover:border-accent"},a[9]||(a[9]=[ft('<div class="flex justify-between gap-2 items-start"><div class="flex items-start gap-3 flex-1"><div class="w-10 h-10 bg-accent/20 flex justify-center items-center rounded-lg"><i class="fa-solid fa-diagram-project text-accent"></i></div><div class="flex-1 min-w-0"><h3 class="text-sm font-semibold text-text-primary leading-tight mb-1"> Custom Process </h3><p class="text-xs text-text-secondary line-clamp-2"> Make custom workflow for handling tasks based on card type. </p></div></div></div>',1)]))]),s("div",{class:"min-w-[328px]",onClick:a[2]||(a[2]=H(()=>{},["stop"]))},[u.value?(U(),q("div",Ds,[r(R,{autofocus:!0,modelValue:C.value,"onUpdate:modelValue":a[1]||(a[1]=L=>C.value=L),placeholder:"Add New Column",onKeyup:ye(T,["enter"])},null,8,["modelValue"]),a[10]||(a[10]=s("p",{class:"text-xs mt-1.5"},"You can add details while editing",-1)),s("div",Ms,[r(z,{onClick:T,variant:"primary",class:"px-3 py-1 bg-accent cursor-pointer text-white rounded"},{default:E(()=>[W(B(V(S)?"Adding...":"Add Column"),1)]),_:1}),s("i",{class:"fa-solid fa-close cursor-pointer",onClick:j})])])):oe("",!0)])]),r(ze,{onClick:a[3]||(a[3]=H(()=>{},["stop"])),modelValue:p.value,"onUpdate:modelValue":a[4]||(a[4]=L=>p.value=L),title:"Delete Column",itemLabel:"column",itemName:(ce=o.value)==null?void 0:ce.title,requireMatchText:(me=o.value)==null?void 0:me.title,confirmText:"Delete column",cancelText:"Cancel",size:"md",loading:V($),onConfirm:O,onCancel:a[5]||(a[5]=()=>{p.value=!1})},null,8,["modelValue","itemName","requireMatchText","loading"]),r(Cs,{modelValue:h.value,"onUpdate:modelValue":a[6]||(a[6]=L=>h.value=L),process:N.value,onClose:ae},null,8,["modelValue","process"]),r($s,{modelValue:w.value,"onUpdate:modelValue":a[7]||(a[7]=L=>w.value=L),onCreated:Y},null,8,["modelValue"]),r(Es,{modelValue:m.value,"onUpdate:modelValue":a[8]||(a[8]=L=>m.value=L),onCreated:le},null,8,["modelValue"])],64)}}});export{js as default};
