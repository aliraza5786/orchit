import{R as J,S as ye,p as k,T as O,d as X,r as b,n as Y,j as q,o as N,ad as Qe,f as o,i as v,L as se,k as ae,t as H,w as V,z as Te,J as be,N as Ie,M as ce,F as me,h as Z,W as Je,ak as Ve,v as Xe,x as Ze,_ as le,ae as ue,B as G,g as K,c as Q,e as ke,X as Ee,D as ve,bd as Ye,P as et,be as tt,U as ge,an as ot,bf as st,ac as Pe,I as at,E as lt}from"./index-D1HTj25s.js";import{D as De}from"./vuedraggable.umd-jgHA8wXs.js";import{_ as Ue}from"./DropMenu.vue_vue_type_script_setup_true_lang-C-JhxsID.js";import{u as nt,_ as Ae}from"./ConfirmDeleteModal.vue_vue_type_script_setup_true_lang-BrcenpPn.js";import{u as rt,_ as it,M as re,a as dt,b as ut,c as ie,P as de,d as ct}from"./useLocalWorkflowState-BAP3KRWt.js";import{_ as mt}from"./BaseTextAreaField.vue_vue_type_script_setup_true_lang-DGkEUZs3.js";import"./_commonjsHelpers-_d1bhYXs.js";const pt=(u,l={})=>ye({queryKey:["process-groups-with-transitions",u],queryFn:({signal:r})=>{const p=k(u);return p?O({url:`workspace/${p}/process-groups/with-transitions?sort=sort_order`,method:"GET",signal:r}):Promise.resolve(null)},enabled:!!k(u),...l}),ft=(u={})=>J({key:["create-process-group"]},{mutationFn:l=>O({url:`workspace/${l.workspace_id}/process-groups`,method:"POST",data:l}),...u}),vt=(u={})=>J({key:["update-process-group"]},{mutationFn:l=>O({url:`workspace/${l.workspace_id}/process-groups/${l.group_id}`,method:"PUT",data:l.payload}),...u}),gt=(u={})=>J({key:["delete-process-group"]},{mutationFn:l=>O({url:`workspace/${l.workspace_id}/process-groups/${l.group_id}`,method:"DELETE"}),...u}),yt=(u={})=>J({key:["reorder-process-groups"]},{mutationFn:l=>O({url:`workspace/${l.workspace_id}/process-groups/reorder`,method:"POST",data:{groups:l.groups}}),...u}),bt=(u={})=>J({key:["create-process-transition"]},{mutationFn:l=>O({url:`workspace/${l.workspace_id}/process-transitions`,method:"POST",data:l}),...u}),Ne=(u={})=>J({key:["update-process-transition"]},{mutationFn:l=>O({url:`workspace/${l.workspace_id}/process-transitions/${l.transition_id}`,method:"POST",data:l.payload}),...u}),kt=(u={})=>J({key:["delete-process-transition"]},{mutationFn:l=>O({url:`workspace/${l.workspace_id}/process-transitions/${l.transition_id}`,method:"DELETE"}),...u}),wt=(u={})=>J({key:["reorder-process-transitions"]},{mutationFn:l=>O({url:`workspace/${l.workspace_id}/process-groups/${l.group_id}/transitions/reorder`,method:"POST",data:{transitions:l.transitions}}),...u}),xt=(u,l,r={})=>ye({queryKey:["process-transition",u,l],queryFn:({signal:p})=>{const g=k(u),d=k(l);return!g||!d?Promise.resolve(null):O({url:`workspace/${g}/process-transitions/${d}`,method:"GET",signal:p})},enabled:!!k(u)&&!!k(l),...r}),_t=(u,l={})=>ye({queryKey:["filtered-card-types",u],queryFn:({signal:r})=>{const p=k(u);return p?O({url:`common/cardtypes-filtered?workspace_id=${p}&default=true`,method:"GET",signal:r}):Promise.resolve(null)},enabled:!!k(u),...l}),Ct={class:"flex items-center justify-between w-full p-4 border-b border-border cursor-grab"},ht={class:"flex items-center gap-2 flex-auto max-w-4/5"},$t={class:"font-semibold text-foreground"},St={class:"text-xs bg-muted bg-bg-card aspect-square flex justify-center items-center text-muted-foreground p-1 min-w-6 rounded-full"},Tt=X({__name:"ProcessKanbanColumn",props:{column:{},canDragList:{type:Boolean},plusIcon:{type:Boolean},index:{},totalColumns:{},listOwnerId:{}},emits:["update:column","delete:column","onPlus","reorder","select:ticket","move:column","drag:start"],setup(u,{emit:l}){const r=u,p=l,g=()=>{p("drag:start",r.column._id)},d=()=>{},w=b(r.column.title);Y(()=>r.column.title,s=>{w.value=s});const x=b([...r.column.transitions??[]]);Y(()=>r.column.transitions,s=>{x.value=[...s??[]]});function _(s){var A,y;const a=s.moved??s.added;if(!a)return;const f=((y=(A=s.from)==null?void 0:A.dataset)==null?void 0:y.columnId)??null;p("reorder",{moved:a.element,fromColumnId:f,toColumnId:r.column._id,oldIndex:a.oldIndex??null,newIndex:a.newIndex??null})}function I(){const s=[];return s.push({label:"Delete",danger:!0,action:()=>D()}),s}const D=()=>{var s;p("delete:column",{title:r.column.title,columnId:(s=r.column)==null?void 0:s._id})};return(s,a)=>(N(),q("div",{class:"flex bg-bg-body flex-col min-h-[565px] h-full w-full rounded-lg transition-all duration-200",style:Qe({borderColor:s.column.color})},[o("div",Ct,[o("div",ht,[o("span",$t,H(s.column.title),1),o("span",St,H(s.column.transitions?s.column.transitions.length:0),1)]),s.plusIcon?(N(),q("i",{key:0,class:"cursor-pointer fa-solid fa-plus",onClick:a[0]||(a[0]=f=>p("onPlus",s.column))})):ae("",!0),v(Ue,{items:I()},{trigger:V(()=>a[2]||(a[2]=[o("i",{class:"fa-solid fa-ellipsis cursor-pointer"},null,-1)])),_:1},8,["items"])]),v(k(De),{disabled:!s.canDragList,modelValue:x.value,"onUpdate:modelValue":a[1]||(a[1]=f=>x.value=f),"item-key":"_id","data-column-id":s.column._id,class:"flex-1 p-4 space-y-3 overflow-y-auto",group:{name:"tickets",pull:!0,put:!0},animation:180,"ghost-class":"kanban-ghost","chosen-class":"kanban-chosen",onStart:g,onEnd:d,"drag-class":"kanban-dragging",onChange:_},{item:V(({element:f,index:A})=>[o("div",null,[se(s.$slots,"ticket",{ticket:f,index:A})])]),footer:V(()=>[x.value.length?ae("",!0):se(s.$slots,"emptyState",{key:0,column:s.column})]),_:3},8,["disabled","modelValue","data-column-id"]),se(s.$slots,"footer",{column:s.column})],4))}}),Vt={class:"h-full flex gap-3"},It=X({__name:"ProcessKanbanBoard",props:{board:{},onBoardUpdate:{},plusIcon:{type:Boolean,default:!0}},emits:["update:board","select:ticket","update:column","delete:column","onPlus","reorder"],setup(u,{emit:l}){const r=nt("(max-width: 650px)"),p=b(!0),g=b(null),d=()=>{p.value=!1},w=y=>{g.value=y},x=u,_=l,I=b(A(x.board));Y(()=>x.board,y=>{I.value=A(y)});function D(y){const C=y.oldIndex,h=y.newIndex,c=I.value.columns[h],n=c==null?void 0:c._id,$=c==null?void 0:c._id;n!=null&&a("column",{id:n,oldIndex:C,newIndex:h,_id:$}),p.value=!0}function s(y){!y.fromColumnId&&g.value&&(y.fromColumnId=g.value),a("ticket",y)}function a(y,C){var c;const h=I.value;_("update:board",h),_("reorder",{type:y,board:h,meta:C}),(c=x.onBoardUpdate)==null||c.call(x,h)}function f({direction:y,column:C}){const h=[...I.value.columns],c=h.findIndex($=>$._id===C._id);if(c===-1)return;let n=c;if(y==="left"&&c>0?n=c-1:y==="right"&&c<h.length-1&&(n=c+1),n!==c){const[$]=h.splice(c,1);h.splice(n,0,$),I.value.columns=h;const M=h[n],z=M==null?void 0:M._id,F=M==null?void 0:M._id;z!=null&&a("column",{id:z,oldIndex:c,newIndex:n,_id:F})}}function A(y){return{columns:((y==null?void 0:y.length)>0?y:[]).map(C=>({...C,title:C==null?void 0:C.title,transitions:(C.transitions??[]).map(h=>({...h}))}))}}return(y,C)=>(N(),q("div",Vt,[v(k(De),{modelValue:I.value.columns,"onUpdate:modelValue":C[4]||(C[4]=h=>I.value.columns=h),"item-key":"_id",group:"columns",animation:180,"ghost-class":"kanban-ghost","chosen-class":"kanban-chosen","drag-class":"kanban-dragging","force-fallback":!0,disabled:k(r),class:Te(["flex gap-3",{"overflow-x-auto snap-x snap-mandatory w-full pb-4 mobile-scroll-visible":k(r),"min-w-max":!k(r)}]),direction:"horizontal",onEnd:D,onStart:d},{item:V(({element:h,index:c})=>[o("div",{class:Te(["rounded-lg bg-bg-surface h-full",{"snap-center min-w-[270px] max-w-[270px]":k(r),"min-w-[320px] max-w-[320px]":!k(r)}])},[v(Tt,{listOwnerId:h._id,plusIcon:y.plusIcon,canDragList:!k(r),onOnPlus:C[0]||(C[0]=n=>_("onPlus",n)),"onUpdate:column":C[1]||(C[1]=n=>_("update:column",n)),index:c,totalColumns:I.value.columns.length,"onSelect:ticket":C[2]||(C[2]=n=>_("select:ticket",n)),"onDelete:column":C[3]||(C[3]=n=>_("delete:column",n)),column:h,onReorder:s,"onDrag:start":w,"onMove:column":f},{emptyState:V(({column:n})=>[se(y.$slots,"emptyState",{column:n},void 0,!0)]),ticket:V(({ticket:n,index:$})=>[se(y.$slots,"ticket",{ticket:n,index:$},void 0,!0)]),footer:V(({column:n})=>[se(y.$slots,"column-footer",{column:n},void 0,!0)]),_:2},1032,["listOwnerId","plusIcon","canDragList","index","totalColumns","column"])],2)]),_:3},8,["modelValue","disabled","class"])]))}}),Et=be(It,[["__scopeId","data-v-b07ae910"]]),Pt={class:"flex justify-between gap-2 items-start"},Dt={class:"flex items-start gap-3 flex-1"},Ut={class:"flex-1 min-w-0"},At={class:"text-sm font-semibold text-text-primary leading-tight mb-1"},Nt={key:0,class:"text-xs text-text-secondary line-clamp-2"},Mt=X({__name:"ProcessKanbanCard",props:{ticket:{},index:{}},emits:["click"],setup(u,{emit:l}){const r=u,p=l,g=b(!1),d=Ie(),{workspaceId:w}=ce();function x(){return[{label:"Open Workflow Builder",action:()=>{p("click")},icon:{prefix:"fa-regular",iconName:"fa-diagram-project"}},{label:"Delete Process",danger:!0,action:()=>{g.value=!0},icon:{prefix:"fa-regular",iconName:"fa-trash"}}]}const{mutate:_,isPending:I}=kt({onSuccess:()=>{g.value=!1,d.invalidateQueries({queryKey:["process-groups-with-transitions"]})}}),D=()=>{_({workspace_id:w.value,transition_id:r.ticket._id})};return(s,a)=>{var f,A;return N(),q(me,null,[o("div",{onClick:a[1]||(a[1]=y=>s.$emit("click")),class:"bg-bg-card rounded-lg p-4 shadow-sm cursor-pointer hover:shadow-md transition-all duration-200 border border-border hover:border-accent"},[o("div",Pt,[o("div",Dt,[a[5]||(a[5]=o("div",{class:"w-10 h-10 bg-accent/20 flex justify-center items-center rounded-lg"},[o("i",{class:"fa-solid fa-diagram-project text-accent"})],-1)),o("div",Ut,[o("h3",At,H(((f=s.ticket)==null?void 0:f.title)??`Process ${s.index+1}`),1),(A=s.ticket)!=null&&A.description?(N(),q("p",Nt,H(s.ticket.description),1)):ae("",!0)])]),v(Ue,{onClick:a[0]||(a[0]=Z(()=>{},["stop"])),items:x()},{trigger:V(()=>a[6]||(a[6]=[o("i",{class:"cursor-pointer fa-solid fa-ellipsis text-text-secondary hover:text-text-primary"},null,-1)])),_:1},8,["items"])])]),v(Ae,{onClick:a[2]||(a[2]=Z(()=>{},["stop"])),modelValue:g.value,"onUpdate:modelValue":a[3]||(a[3]=y=>g.value=y),title:"Delete Process",itemLabel:"process",itemName:s.ticket.title,requireMatchText:s.ticket.title,confirmText:"Delete Process",cancelText:"Cancel",size:"md",loading:k(I),onConfirm:D,onCancel:a[4]||(a[4]=()=>{g.value=!1})},null,8,["modelValue","itemName","requireMatchText","loading"])],64)}}}),Bt={class:"workflow-wrap"},Lt={class:"relative min-w-[90px] px-2 py-1 rounded-md text-sm"},zt={class:"flex justify-between items-center gap-2"},Wt={class:"truncate"},qt={class:"flex items-center gap-1.5"},Ft=["onClick"],jt=["onClick"],Kt={class:"modal border border-border !bg-bg-body text-text-primary"},Gt={class:"modal-actions mt-4"},Ot={class:"modal border border-border !bg-bg-body text-text-primary"},Ht={class:"modal-actions mt-4"},Rt=X({__name:"WorkflowCanvas",props:{processId:{},showTransitionLabels:{type:Boolean},workflowData:{}},emits:["edit:node","save","update:workflow","add:status","add:transition"],setup(u,{expose:l,emit:r}){const p=b(!1),g=b(""),d=b(null),w=b([]),x=b([]),{setNodes:_,updateNode:I,addEdges:D,setEdges:s,removeEdges:a,onNodesInitialized:f,fitView:A,updateNodeInternals:y,addNodes:C,project:h,getNodes:c,getEdges:n,zoomIn:$,zoomOut:M}=rt(),{workspaceId:z}=Je(),F=u;Y(()=>F.workflowData,async e=>{if(e){const t=e.flow_diagram||e,i=Array.isArray(t.nodes)?t.nodes.map(T):[],U=Array.isArray(t.edges)?t.edges.map(W):[];await Ve(),_(i),f(async()=>{i.forEach(B=>y(B.id)),s(U),A({padding:.8})})}},{immediate:!0});function ee(){const e=we();fe("save",e)}function ne(){const e=we();console.log(" >>> saving workflow (process2)",e),fe("save",e)}l({openCreateNodeModal:Me,handleAddNode:ze,saveWorkflow:ne,triggerSave:ee,handleConfirmEdit:Le});function T(e){return{id:e.id,type:e.type??"default",position:e.position,data:e.data,style:e.style}}function E(e){const t=(e??"arrow").toLowerCase();return t==="arrow"?re.Arrow:t==="arrowclosed"?re.ArrowClosed:re.Arrow}function W(e){var U,B,he,$e,Se;const t=e.markerEnd||e.marker_end,i=e.style;return{id:e.id||((U=e.flow_metadata)==null?void 0:U.transition_id),type:e.type??"step",source:e.source??((he=(B=e.flow_metadata)==null?void 0:B.source_node)==null?void 0:he.id),target:e.target??((Se=($e=e.flow_metadata)==null?void 0:$e.target_node)==null?void 0:Se.id),sourceHandle:e.sourceHandle??e.source_handle,targetHandle:e.targetHandle??e.target_handle,label:e.label,data:e.data,animated:e.animated??!1,style:i?{...i,strokeWidth:Number(i.strokeWidth??2)}:void 0,markerEnd:t?{type:E(t.type),color:t.color,width:Number(t.width??18),height:Number(t.height??18)}:void 0}}function pe(e){oe.value=e,R.value="",P.value=!0}function S(){var B;if(!oe.value)return;const e=oe.value,t=R.value.trim()||"Transition",i=`${e.source}-${e.target}-${((B=crypto.randomUUID)==null?void 0:B.call(crypto))??Math.random()}`,U={...e,id:i,type:"step",label:t,data:{name:t},style:{stroke:"#1152de",strokeWidth:2},markerEnd:{type:re.Arrow,color:"#1152de",width:18,height:18},sourceHandle:e.sourceHandle,targetHandle:e.targetHandle};D(U),P.value=!1,oe.value=null,R.value=""}function m(){P.value=!1,oe.value=null,R.value=""}const L={type:"default",animated:!1,style:{strokeWidth:2},markerEnd:{type:re.Arrow,color:"#3b82f6",width:18,height:18},labelBgPadding:[6,2],labelBgBorderRadius:6,updatable:!0},j=b(!1),te=b(""),P=b(!1),R=b(""),oe=b(null),fe=r;function Me(){te.value="",j.value=!0}function Be(e,t){const i=c.value.find(U=>U.id===e);console.log(i,">>>>"),i&&fe("edit:node",{id:e,...i.data,status_color:t.status||"#6b7280"})}function Le(e,t){t&&I(e,i=>({...i,data:{...i.data,label:t.name,status:t.category},style:{border:"2px solid #64748b",borderRadius:"8px",background:t.status_color}})),Ve()}async function ze(e){const i=(()=>{var B;return((B=crypto.randomUUID)==null?void 0:B.call(crypto))??`n-${Date.now()}-${Math.random()}`})(),U=h({x:e.position_x,y:e.position_y});C({id:i,position:U,data:{label:e.name,status:e.status_name},style:{border:"2px solid #64748b",borderRadius:"8px",background:e.status_color}})}function We(e){if(!e)return;const t=String(e).toLowerCase();return t.includes("arrowclosed")?"arrowclosed":t.includes("arrow")?"arrow":t.includes("circle")?"circle":t.includes("square")?"square":t.includes("diamond")?"diamond":t.includes("dot")?"dot":"arrow"}function qe(e){return{id:e.id,type:e.type??"default",position:e.position,data:e.data,style:e.style}}function Fe(e){const t=e.markerEnd,i=t?(()=>{const U=typeof t=="string"?t:t.type;return{type:We(U),color:typeof t=="string"?void 0:t.color,width:typeof t=="string"?void 0:Number(t.width??18),height:typeof t=="string"?void 0:Number(t.height??18)}})():void 0;return{id:e.id,type:e.type??"step",source:e.source,target:e.target,source_handle:e.sourceHandle,target_handle:e.targetHandle,label:e.label,data:e.data,style:e.style?{...e.style,strokeWidth:Number(e.style.strokeWidth??2)}:void 0,marker_end:i,animated:!!e.animated}}function we(){const e=c.value,t=n.value;return{workspace_id:z.value,flow_diagram:{nodes:e.map(qe),edges:t.map(Fe)}}}window.addEventListener("beforeunload",()=>{});function je(e){var t;console.log(e,"edge"),d.value=e.id,g.value=String(e.label??((t=e.data)==null?void 0:t.name)??""),p.value=!0}function xe(){if(!d.value)return;const e=g.value.trim();s(t=>t.map(i=>{var U;return i.id===d.value?{...i,label:e||i.label,data:{...i.data??{},name:e||((U=i.data)==null?void 0:U.name)}}:i})),p.value=!1,d.value=null,g.value=""}function Ke(){d.value&&(a([d.value]),p.value=!1,d.value=null,g.value="")}function Ge(e){_(t=>t.filter(i=>i.id!==e)),s(t=>t.filter(i=>i.source!==e&&i.target!==e)),d.value=null}function Oe(e){window.confirm("Are you sure you want to delete this status? All transitions will also be removed.")&&Ge(e)}function He(e){const{edge:t,connection:i}=e;!t||!i||s(U=>U.map(B=>B.id===t.id?{...B,source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle}:B))}function _e(){p.value=!1,d.value=null,g.value=""}function Re({event:e,edge:t}){console.log(">>> click",t),je(t),e.stopPropagation()}Xe(()=>{window.addEventListener("workflow:zoom",Ce)}),Ze(()=>{window.removeEventListener("workflow:zoom",Ce)});function Ce(e){const t=e.detail;t&&(t.action==="in"&&$(),t.action==="out"&&M(),t.action==="reset"&&A({padding:.8}))}return(e,t)=>(N(),q(me,null,[o("div",Bt,[v(k(it),{nodes:w.value,"onUpdate:nodes":t[0]||(t[0]=i=>w.value=i),edges:x.value,"onUpdate:edges":t[1]||(t[1]=i=>x.value=i),"default-edge-options":L,"nodes-draggable":!0,"nodes-connectable":!0,"elements-selectable":!0,"fit-view-on-init":"",onConnect:pe,onEdgeClick:Re,onEdgeUpdate:He,"edge-updater-radius":20},{"node-default":V(({id:i,data:U})=>[o("div",Lt,[o("div",zt,[o("span",Wt,H(U.label),1),o("div",qt,[o("i",{class:"fa-solid fa-edit cursor-pointer text-xs opacity-70 hover:opacity-100",onClick:Z(B=>Be(i,U),["stop"])},null,8,Ft),o("i",{class:"fa-solid fa-trash cursor-pointer text-red-500/80 hover:text-red-500 text-xs",onClick:Z(B=>Oe(i),["stop"])},null,8,jt)])]),v(k(ie),{id:"in-top",type:"target",position:k(de).Top},null,8,["position"]),v(k(ie),{id:"out-right",type:"source",position:k(de).Right},null,8,["position"]),v(k(ie),{id:"out-bottom",type:"source",position:k(de).Bottom},null,8,["position"]),v(k(ie),{id:"in-left",type:"target",position:k(de).Left},null,8,["position"])])]),default:V(()=>[v(k(dt)),v(k(ut))]),_:1},8,["nodes","edges"]),P.value?(N(),q("div",{key:0,class:"modal-backdrop",onClick:Z(m,["self"])},[o("div",Kt,[t[6]||(t[6]=o("h3",null,"Name this transition",-1)),v(le,{modelValue:R.value,"onUpdate:modelValue":t[2]||(t[2]=i=>R.value=i),placeholder:"e.g., Start work, Complete",onKeyup:ue(S,["enter"]),autofocus:""},null,8,["modelValue"]),o("div",Gt,[v(G,{size:"sm",onClick:S},{default:V(()=>t[4]||(t[4]=[K("Add Transition")])),_:1,__:[4]}),v(G,{variant:"secondary",size:"sm",onClick:m},{default:V(()=>t[5]||(t[5]=[K("Cancel")])),_:1,__:[5]})])])])):ae("",!0)]),p.value?(N(),q("div",{key:0,class:"modal-backdrop",onClick:Z(_e,["self"])},[o("div",Ot,[t[10]||(t[10]=o("h3",null,"Edit transition",-1)),v(le,{modelValue:g.value,"onUpdate:modelValue":t[3]||(t[3]=i=>g.value=i),placeholder:"Transition name",onKeyup:ue(xe,["enter"]),autofocus:""},null,8,["modelValue"]),o("div",Ht,[v(G,{size:"sm",onClick:xe},{default:V(()=>t[7]||(t[7]=[K("Save")])),_:1,__:[7]}),v(G,{variant:"secondary",size:"sm",onClick:_e},{default:V(()=>t[8]||(t[8]=[K("Cancel")])),_:1,__:[8]}),v(G,{size:"sm",variant:"danger",onClick:Ke},{default:V(()=>t[9]||(t[9]=[K(" Delete ")])),_:1,__:[9]})])])])):ae("",!0)],64))}}),Qt=be(Rt,[["__scopeId","data-v-c0f6f17d"]]),Jt={class:"p-6"},Xt={class:"text-lg font-semibold text-text-primary mb-4"},Zt={class:"space-y-4"},Yt={class:"flex items-center gap-3"},eo={class:"mt-6 flex justify-end gap-2"},to=X({__name:"AddStatusModal",props:{modelValue:{type:Boolean},processId:{},editingStatus:{}},emits:["update:modelValue","status:added","edit:node"],setup(u,{emit:l}){const r=u,p=l,g=Q({get:()=>r.modelValue,set:c=>p("update:modelValue",c)}),d=tt("workflowState"),w=b(""),x=b("todo"),_=b("#6b7280"),I=b(!1),D=b(!1),s=b(!1),a={todo:"#6b7280",inprogress:"#3b82f6",done:"#10b981"},f=Q(()=>!!r.editingStatus);Y(r,()=>{var c,n,$,M,z,F;w.value=((c=r.editingStatus)==null?void 0:c.label)||"",x.value=((n=r.editingStatus)==null?void 0:n.status)||"todo",_.value=(($=r.editingStatus)==null?void 0:$.status_color)||((M=r.editingStatus)==null?void 0:M.status)||"#6b7280",I.value=((z=r.editingStatus)==null?void 0:z.is_initial)||!1,D.value=((F=r.editingStatus)==null?void 0:F.is_final)||!1});function A(){_.value=a[x.value]}function y(){}function C(){w.value="",g.value=!1}function h(){if(w.value.trim()){s.value=!0;try{if(f.value){console.log("editing mode on ");const c={...r.editingStatus,name:w.value.trim(),category:x.value,status_color:_.value,is_initial:I.value,is_final:D.value,status_name:w.value.trim()};d.updateStatus(r.editingStatus.id,c),p("edit:node",r.editingStatus.id,c)}else{console.log("editing mode close ");const c={process_id:r.processId,name:w.value.trim(),category:x.value,status_color:_.value,is_initial:I.value,is_final:D.value,status_name:x.value.trim(),position_x:Math.random()*400+100,position_y:Math.random()*300+100,order:d.localStatuses.value.length};d.addStatus(c),p("status:added",c)}C()}catch{ge.error(f.value?"Failed to update status":"Failed to add status")}finally{s.value=!1}}}return(c,n)=>(N(),ke(Ee,{modelValue:g.value,"onUpdate:modelValue":n[4]||(n[4]=$=>g.value=$),size:"md"},{default:V(()=>[o("div",Jt,[o("h3",Xt,H(f.value?"Edit Status":"Add Status"),1),o("div",Zt,[o("div",null,[n[5]||(n[5]=o("label",{class:"text-sm font-medium text-text-primary mb-1.5 block"},"Status Name",-1)),v(le,{modelValue:w.value,"onUpdate:modelValue":n[0]||(n[0]=$=>w.value=$),placeholder:"e.g., To Do, In Progress, Done",autofocus:!0},null,8,["modelValue"])]),o("div",null,[n[7]||(n[7]=o("label",{class:"text-sm font-medium text-text-primary mb-1.5 block"},"Category",-1)),ve(o("select",{"onUpdate:modelValue":n[1]||(n[1]=$=>x.value=$),onChange:A,class:"w-full px-3 py-2 text-sm bg-bg-surface border border-border rounded-md text-text-primary focus:outline-none focus:ring-1 focus:ring-accent"},n[6]||(n[6]=[o("option",{value:"todo"},"To Do",-1),o("option",{value:"inprogress"},"In Progress",-1),o("option",{value:"done"},"Done",-1)]),544),[[Ye,x.value]]),n[8]||(n[8]=o("p",{class:"text-xs text-text-secondary mt-1"},"Category cannot be changed after creation",-1))]),o("div",null,[n[9]||(n[9]=o("label",{class:"text-sm font-medium text-text-primary mb-1.5 block"},"Status Color",-1)),o("div",Yt,[ve(o("input",{type:"color","onUpdate:modelValue":n[2]||(n[2]=$=>_.value=$),onInput:y,class:"h-10 w-20 rounded border border-border cursor-pointer"},null,544),[[et,_.value]]),v(le,{modelValue:_.value,"onUpdate:modelValue":n[3]||(n[3]=$=>_.value=$),placeholder:"#3b82f6",class:"flex-1"},null,8,["modelValue"])])])]),o("div",eo,[v(G,{onClick:C,variant:"secondary"},{default:V(()=>n[10]||(n[10]=[K("Cancel")])),_:1,__:[10]}),v(G,{onClick:h,disabled:!w.value.trim()||s.value},{default:V(()=>[K(H(s.value?f.value?"Updating...":"Adding...":f.value?"Update Status":"Add Status"),1)]),_:1},8,["disabled"])])])]),_:1},8,["modelValue"]))}}),oo={class:"relative flex h-full w-full flex-col bg-bg-body",role:"dialog","aria-modal":"true",tabindex:"0"},so={class:"border-b border-border px-[20px] sm:px-6 py-4 overflow-x-auto"},ao={class:"flex items-center justify-between max-w-content gap-3"},lo={class:"flex items-center gap-4"},no={class:"flex items-center gap-2 text-lg sm:text-xl font-semibold text-text-primary text-nowrap"},ro={class:"flex items-center gap-3"},io={class:"relative flex-1 overflow-hidden"},uo={key:0,class:"flex items-center justify-center h-full bg-bg-surface"},co=X({__name:"ProcessWorkflowBuilderModal",props:{modelValue:{type:Boolean},process:{}},emits:["update:modelValue","close"],setup(u,{emit:l}){const r=u,p=l,g=b(null),d=b(!1),w=b(null),x=Q(()=>r.modelValue),_=Q(()=>{var T,E;return((T=r.process)==null?void 0:T._id)??((E=r.process)==null?void 0:E.id)??""}),I=Q(()=>{var T;return((T=r.process)==null?void 0:T.title)??"Process Workflow"}),{workspaceId:D}=ce(),{data:s,isLoading:a,refetch:f}=xt(D,_,{enabled:Q(()=>x.value&&!!_.value)}),A=ct();st("workflowState",A),Y(()=>s.value,T=>{T&&x.value});const{mutate:y,isPending:C}=Ne({onSuccess:()=>{f()}}),h=Q(()=>C.value?"Saving...":"Save Workflow");function c(){var T;(T=g.value)==null||T.triggerSave()}function n(T){y({workspace_id:D.value,transition_id:_.value,payload:{raw_object:T}})}function $(){p("update:modelValue",!1),p("close")}function M(){d.value=!0,w.value=""}function z(T){var E,W;d.value=!1,(W=(E=g.value)==null?void 0:E.handleAddNode)==null||W.call(E,T)}function F(T){w.value=T,d.value=!0}function ee(T,E){var W;(W=g.value)==null||W.handleConfirmEdit(T,E)}function ne(){f()}return(T,E)=>(N(),q(me,null,[v(ot,{name:"fade"},{default:V(()=>{var W;return[x.value?(N(),q("div",{key:0,class:"fixed inset-0 z-50 bottom-[60px] sm:bottom-0 flex items-center justify-center bg-black/80 backdrop-blur-sm",onKeydown:ue($,["esc"])},[o("div",oo,[o("div",so,[o("div",ao,[o("div",lo,[o("h2",no,[E[1]||(E[1]=o("i",{class:"fa-solid fa-diagram-project text-accent","aria-hidden":"true"},null,-1)),K(" Workflow for "+H(I.value),1)])]),o("div",ro,[v(G,{variant:"secondary",size:"sm",onClick:M},{default:V(()=>E[2]||(E[2]=[o("i",{class:"fa-solid fa-plus mr-2","aria-hidden":"true"},null,-1),K(" Add Status ")])),_:1,__:[2]}),v(G,{variant:"primary",size:"sm",disabled:k(C),onClick:c},{default:V(()=>[K(H(h.value),1)]),_:1},8,["disabled"]),o("button",{class:"text-xl text-text-secondary hover:text-text-primary",onClick:$,"aria-label":"Close"},E[3]||(E[3]=[o("i",{class:"fa-solid fa-times","aria-hidden":"true"},null,-1)]))])])]),o("div",io,[k(a)?(N(),q("div",uo,E[4]||(E[4]=[o("div",{class:"flex flex-col items-center gap-4"},[o("div",{class:"animate-spin rounded-full h-12 w-12 border-4 border-accent border-t-transparent"}),o("p",{class:"text-sm text-text-secondary"},"Loading workflow data...")],-1)]))):(N(),ke(Qt,{key:1,ref_key:"Canvas",ref:g,"process-id":_.value,"workflow-data":((W=k(s))==null?void 0:W.raw_object)||{},"show-transition-labels":!0,onSave:n,"onUpdate:workflow":ne,"onAdd:status":M,"onEdit:node":F},null,8,["process-id","workflow-data"]))])])],32)):ae("",!0)]}),_:1}),v(to,{modelValue:d.value,"onUpdate:modelValue":E[0]||(E[0]=W=>d.value=W),"process-id":_.value,"editing-status":w.value,"onStatus:added":z,"onEdit:node":ee},null,8,["modelValue","process-id","editing-status"])],64))}}),mo=be(co,[["__scopeId","data-v-8f8f110a"]]),po={class:"p-6"},fo={class:"space-y-4"},vo={class:"space-y-2"},go={class:"flex justify-end gap-3 mt-6"},yo=X({__name:"AddTransitionModal",props:{modelValue:{type:Boolean},group:{}},emits:["update:modelValue","created"],setup(u,{emit:l}){const r=u,p=l,{workspaceId:g}=ce(),d=b({title:"",description:"",variable_type:"",transition_type:"forward"});Pe(()=>{console.log(d.value.variable_type)});const{data:w}=_t(g),x=Q(()=>{var a;return w.value?(Array.isArray(w.value)?w.value:((a=w.value)==null?void 0:a.data)||[]).map(f=>({title:f.title||f.name,_id:f._id||f.id})):[]}),{mutate:_,isPending:I}=bt({onSuccess:()=>{ge.success("Process created successfully"),p("created"),p("update:modelValue",!1),d.value={title:"",description:"",variable_type:"",transition_type:"forward"}},onError:s=>{ge.error((s==null?void 0:s.message)||"Failed to create process")}}),D=()=>{if(!d.value.title||!d.value.variable_type)return;const s=x.value.find(f=>f._id===d.value.variable_type),a=s?s.title:d.value.variable_type;_({workspace_id:g.value,group_id:r.group._id,...d.value,variable_type:a,sort_id:r.group.cards?r.group.cards.length:0})};return(s,a)=>(N(),ke(Ee,{modelValue:s.modelValue,"onUpdate:modelValue":a[4]||(a[4]=f=>s.$emit("update:modelValue",f)),size:"md"},{default:V(()=>[o("div",po,[a[8]||(a[8]=o("h2",{class:"text-xl font-semibold text-text-primary mb-6"},"Add Process Card",-1)),o("div",fo,[v(le,{label:"Title",modelValue:d.value.title,"onUpdate:modelValue":a[0]||(a[0]=f=>d.value.title=f),placeholder:"e.g. Start Task",autofocus:!0},null,8,["modelValue"]),o("div",vo,[a[5]||(a[5]=o("label",{class:"block text-sm font-medium text-text-primary"},"Variable Type",-1)),v(at,{modelValue:d.value.variable_type,"onUpdate:modelValue":a[1]||(a[1]=f=>d.value.variable_type=f),options:x.value,placeholder:"Select Type",class:"w-full"},null,8,["modelValue","options"])]),v(mt,{label:"Description",modelValue:d.value.description,"onUpdate:modelValue":a[2]||(a[2]=f=>d.value.description=f),placeholder:"Optional description"},null,8,["modelValue"]),o("div",go,[v(G,{variant:"secondary",onClick:a[3]||(a[3]=f=>s.$emit("update:modelValue",!1))},{default:V(()=>a[6]||(a[6]=[K("Cancel")])),_:1,__:[6]}),v(G,{variant:"primary",onClick:D,loading:k(I)},{default:V(()=>a[7]||(a[7]=[K("Create Process")])),_:1,__:[7]},8,["loading"])])])])]),_:1},8,["modelValue"]))}}),bo={class:"flex-auto flex-grow h-full bg-bg-card rounded-lg border border-border overflow-hidden flex flex-col"},ko={class:"flex-1 w-full p-4 overflow-x-auto flex items-start gap-4"},wo={class:"min-w-[300px] max-w-[300px] shrink-0"},xo={key:1,class:"bg-bg-body rounded-lg p-3 border border-border shadow-sm"},_o={class:"flex items-center gap-2"},Eo=X({__name:"Process2",setup(u){const{workspaceId:l}=ce(),{data:r}=pt(l.value);Pe(()=>{console.log(r.value,"this ....")});const p=b([]);Y(r,S=>{var L;const m=((L=S==null?void 0:S.data)==null?void 0:L.groups)||(S==null?void 0:S.groups)||[];m&&(p.value=m.map(j=>({...j,cards:j.transitions||[]})))},{immediate:!0});const g=b(!1),d=b(""),w=Ie(),{mutate:x,isPending:_}=ft({onSuccess:()=>{d.value="",g.value=!1,w.invalidateQueries({queryKey:["process-groups-with-transitions"]})}});function I(){const S=d.value.trim();S&&x({workspace_id:l.value,title:S,sort_order:p.value.length})}const D=b(!1),s=b(null),{mutate:a,isPending:f}=gt({onSuccess:()=>{D.value=!1,w.invalidateQueries({queryKey:["process-groups-with-transitions"]})}}),A=S=>{s.value=S,D.value=!0},y=()=>{s.value&&a({workspace_id:l.value,group_id:s.value.columnId})},{mutate:C}=vt({onSuccess:()=>{w.invalidateQueries({queryKey:["process-groups-with-transitions"]})}}),h=S=>{C({workspace_id:l.value,group_id:S._id,payload:{title:S.title}})},{mutate:c}=yt(),{mutate:n}=wt(),{mutate:$}=Ne({onSuccess:()=>{w.invalidateQueries({queryKey:["process-groups-with-transitions"]})}}),M=S=>{if(S.type==="column"){const m=S.board.columns.map((L,j)=>({group_id:L._id,sort_order:j}));c({workspace_id:l.value,groups:m})}else if(S.type==="ticket"){const m=S.meta;if(console.log(p.value,"..."),console.log("hites",m),m.fromColumnId===m.toColumnId){const L=p.value.find(j=>j._id===m.toColumnId);if(L){const j=L.cards.map((te,P)=>({transition_id:te._id,sort_id:P}));n({workspace_id:l.value,group_id:m.toColumnId,transitions:j})}}else{const L=m.moved;L&&m.toColumnId&&$({workspace_id:l.value,transition_id:L._id,payload:{group_id:m.toColumnId}})}}},z=b(null),F=b(!1),ee=S=>{requestAnimationFrame(()=>{z.value=S,console.log(z.value,"this is the selected process"),F.value=!0})},ne=()=>{F.value=!1,z.value=null},T=b(!1),E=b(null),W=S=>{E.value=S,T.value=!0},pe=()=>{T.value=!1,w.invalidateQueries({queryKey:["process-groups-with-transitions"]})};return(S,m)=>{var L,j,te;return N(),q(me,null,[o("div",bo,[o("div",ko,[ve(v(Et,{"onDelete:column":m[0]||(m[0]=P=>A(P)),"onUpdate:column":m[1]||(m[1]=P=>h(P)),onOnPlus:W,"onSelect:ticket":ee,board:p.value,onReorder:M},{ticket:V(({ticket:P,index:R})=>[v(Mt,{onClick:oe=>ee(P),ticket:P,index:R},null,8,["onClick","ticket","index"])]),_:1},8,["board"]),[[lt,((L=p.value)==null?void 0:L.length)>0]]),o("div",wo,[g.value?(N(),q("div",xo,[v(le,{autofocus:!0,modelValue:d.value,"onUpdate:modelValue":m[3]||(m[3]=P=>d.value=P),placeholder:"Group details...",class:"mb-2",onKeyup:ue(I,["enter"])},null,8,["modelValue"]),o("div",_o,[v(G,{onClick:I,variant:"primary",size:"sm",loading:k(_)},{default:V(()=>m[11]||(m[11]=[K(" Add Group ")])),_:1,__:[11]},8,["loading"]),o("i",{class:"fa-solid fa-close cursor-pointer text-text-secondary hover:text-text-primary px-2",onClick:m[4]||(m[4]=P=>g.value=!1)})])])):(N(),q("div",{key:0,onClick:m[2]||(m[2]=P=>g.value=!0),class:"h-[50px] w-full border border-border bg-bg-surface/50 hover:bg-bg-surface rounded-lg flex items-center justify-center gap-2 cursor-pointer text-text-secondary hover:text-text-primary transition-colors"},m[10]||(m[10]=[o("i",{class:"fa-solid fa-plus"},null,-1),o("span",{class:"font-medium"},"Add Process Group",-1)])))])])]),v(Ae,{onClick:m[5]||(m[5]=Z(()=>{},["stop"])),modelValue:D.value,"onUpdate:modelValue":m[6]||(m[6]=P=>D.value=P),title:"Delete Group",itemLabel:"group",itemName:(j=s.value)==null?void 0:j.title,requireMatchText:(te=s.value)==null?void 0:te.title,confirmText:"Delete Group",cancelText:"Cancel",size:"md",loading:k(f),onConfirm:y,onCancel:m[7]||(m[7]=()=>{D.value=!1})},null,8,["modelValue","itemName","requireMatchText","loading"]),v(yo,{modelValue:T.value,"onUpdate:modelValue":m[8]||(m[8]=P=>T.value=P),group:E.value,onCreated:pe},null,8,["modelValue","group"]),v(mo,{modelValue:F.value,"onUpdate:modelValue":m[9]||(m[9]=P=>F.value=P),process:z.value,onClose:ne},null,8,["modelValue","process"])],64)}}});export{Eo as default};
